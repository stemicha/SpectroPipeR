#' SpectroPipeR: normalization & quantification module
#' @description
#'  Function for normalizing and quantifying Spectronaut output reports,
#'  serving as the second step in the pipeline and building upon the initial step of
#'  reading Spectronaut data.
#'
#'
#' @param SpectroPipeR_data it is the SpectroPipeR_data list object generated by
#' the read_spectronaut_module() function
#' @param batch_adjusting logical - if batch adjusting with ComBat (sva package) should be performed;
#'  default = FALSE
#' @param batch_adjusting_column character - column name in sample__batch_meta_data_file,
#'  which should be used for assigning the samples to batches
#' @param sample__batch_meta_data_file character - sample batch file; tab-delimited txt-file,
#'  containing "R.FileName" column e.g. sample__batch_meta_data_file = "Sample_MetaData_Batches.txt"
#'
#' _example table for batch meta data:_
#' | <u> __R.FileName__ </u> | <u> __digest_batch__ </u> |
#' |:------------------------|:------------------------|
#' |20230403_TIMSTOF_1_S1-B11_1_6690|1|
#' |20230403_TIMSTOF_2_S1-G11_1_6695|1|
#' |20230403_TIMSTOF_3_S1-E7_1_6661|1|
#' |20230403_TIMSTOF_4_S1-A9_1_6673|2|
#' |20230403_TIMSTOF_7_S1-D8_1_6668|2|
#' |20230403_TIMSTOF_9_S1-D3_1_6627|2|
#'
#' **A good starting point for the generation of the table is the '*_ConditionSetup.tsv' in your Spectronaut Pipeline Report export folder**
#'
#' @param skipping_MaxLFQ_median_norm logical - if median normalization after MaxLFQ calculation
#'  should be skipped; default = FALSE; applied only if MaxLFQ protein estimation is selected
#' @param number_of_cores_adjusting numeric - number of processor cores used for batch or covariate
#'  adjustment
#' @param covariate_adjusting_formula character - provide a formula passed to lm() for covariate
#'  adjustment e.g. "log10_peptide_intensity ~ log10(CRP)+log10(age)+as.factor(sex)"; you may also use
#'  ns() function e.g. "log10_peptide_intensity ~ ns(age, df=3)"
#' @param covariate_adjusting_meta_data_file covariate meta csv file, containing "R.FileName; age; sex;...";
#'  you may find a start file in the 02_ID_rate folder > file_list.csv column e.g.
#'  covariate_adjusting_meta_data_file = "covariate_MetaData_file.csv"
#'
#' _example table for covariate meta data:_
#' | <u> __R.FileName__ </u> | <u> __R.FileName_raw__ </u> | <u> __R.Condition__ </u>| <u> __sex__ </u>| <u> __CRP__ </u>|
#' |:------------------------|:------------------------|:----------------|:----------------|:----------------|
#' |20230403_TIMS..._S1-B11_1_6690|20230403_TIMSTOF_1_S1-B11_1_6690|heathy|1|3.8|
#' |20230403_TIMS..._S1-G11_1_6695|20230403_TIMSTOF_2_S1-G11_1_6695|heathy|2|5.1|
#' |20230403_TIMS...3_S1-E7_1_6661|20230403_TIMSTOF_3_S1-E7_1_6661|heathy|1|1.2|
#' |20230403_TIMS...4_S1-A9_1_6673|20230403_TIMSTOF_4_S1-A9_1_6673|cancer|1|50.2|
#' |20230403_TIMS...7_S1-D8_1_6668|20230403_TIMSTOF_7_S1-D8_1_6668|cancer|2|30.8|
#' |20230403_TIMS...9_S1-D3_1_6627|20230403_TIMSTOF_9_S1-D3_1_6627|cancer|2|64.1|
#'
#' @param costum_colors if you would like to use your own colors please provide a named color vector (e.g. c(condition1 = "black", condition2 = "grey")); names should have the same naming and length like the conditions set in Spectronaut
#' @param print.plot logical - should a plot of normalization factors be printed
#'
#' @return SpectroPipeR_norm_quant list object with the loaded raw data and processed data tables, in addition to the automatically saved tables and plots
#'  For the description of the generated figures and tables please read the manual & vignettes
#'
#' | <u> __list element__ </u> | <u> __description__ </u>              |
#' |:--------------------------|:--------------------------------------|
#' | data_input_normalized     | *tibble:* Spectronaut report tibble provided for the analysis |
#' | MedianNormalizationFactor | *tibble:* ion normalization factor table |
#' | MedianNormalizationFactor_outlier | *tibble:* table containing detected norm. outliers on ion level |
#' | NormFactor_plot            | *ggplot2 plot:* norm. factor plots |
#' | iBAQ_intensities           | *tibble:* table containing the iBAQ int. |
#' | iBAQ_intensities_summary   | *tibble:* table containing the per condition summarized iBAQ int. |
#' | protein_data      | *tibble:* protein intensity table (e.g. Hi3 or MaxLFQ int.)|
#' | PG_2_peptides_ID_raw      | *tibble:* with protein groups with at least 2 peptides with peptide
#' |                           | and replicate count |
#' | protein_data_normalization_factor| *tibble:* normalization factor table for protein int. data |
#' | peptide_intensity_filtered_2pep_hi3| *tibble:* if Hi3 protein int. was selected a table containing |
#' |                            | the peptides and intensities used for Hi3 protein intensity calculation |
#' | peptide_intensity             | *tibble:* peptides intensity table based on norm. ion intensity |
#' | parameter                 | *list:* parameters provided by the user updated with the |
#' |                           | norm_quant_module() parameters|
#' | CV_cumulative_frequency   | *tibble:* cumulative frequency table on peptide |
#' |                           | and protein intensity level |
#' | sample_length             | *numberical value:* number of samples in the provided Spectronaut report |
#'
#'
#' @details
#' **batch adjustment**
#'
#' Batch effects refer to systematic differences between batches (groups) of samples in high-throughput experiments.
#' These differences can arise due to various factors, such as batch variations in sample preparation, handling, processing
#' procedures and measurement orders. Batch effects can obscure the true biological signal and lead to incorrect conclusions
#' if not properly accounted for.
#' In the SpectroPipeR pipeline, the ComBat tool was employed to adjust for batch effects in the datasets where the batch
#' covariate was known. ComBat utilizes the methodology described in [Johnson et al. 2007](https://pubmed.ncbi.nlm.nih.gov/16632515/).
#' It uses an empirical Bayes (EB) framework for adjusting data for batch effects that is robust to outliers in small sample sizes
#' and performs comparable to existing methods for large samples. [Johnson et al. 2007:](https://pubmed.ncbi.nlm.nih.gov/16632515/)
#' This method incorporates systematic batch biases common across genes in making adjustments, assuming that phenomena resulting in
#' batch effects often affect many genes in similar ways (i.e. increased expression, higher variability, etc). Specifically, the
#' the L/S model parameters are estimated that represent the batch effects by pooling information across peptides in each
#' batch to shrink the batch effect parameter estimates toward the overall mean of the batch effect estimates (across genes).
#' These EB estimates are then used to adjust the data for batch effects, providing more robust adjustments for the batch effect on each peptide.
#' In SpectroPipeR a parametric ComBAT emperical Bayes adjustment is implemented by utilizing the sva-package.
#'
#' **covariate adjustment**
#'
#' If a covariate adjustment of peptide intensity data was performed using the users input formula,
#' a linear mixed model (LMM) was calculated based on that formula per peptide and the outcoming
#' residuals were added to the mean peptide intensity over the samples. This means that the adjusted
#' peptide intensities retain their intensity level (low intense peptides keep their low intensity and
#' high intense ions keep their higher intensity).
#'
#' @md
#' @importFrom stats median sd lm as.formula quantile
#' @import ggplot2
#' @import tidyverse
#' @import readr
#' @import tidyr
#' @import broom
#' @importFrom modelr add_residuals
#' @import FactoMineR
#' @import grDevices
#' @import utils
#' @import iq
#' @importFrom methods is
#' @import openxlsx
#' @import forcats
#' @import gghalves
#' @import rlang
#' @import hexbin
#' @import dplyr
#' @importFrom dplyr filter
#' @import BiocParallel
#' @import foreach
#' @import doParallel
#' @import doSNOW
#' @importFrom GGally ggpairs ggally_points ggally_barDiag wrap
#' @import sva
#' @import stringr
#' @import splines
#' @importFrom summarytools dfSummary
#' @import patchwork
#' @importFrom purrr map map2
#' @import tibble
#'
#' @export
#'
#' @examples
#'#load library
#'library(SpectroPipeR)
#'
#'# use default parameters list
#'params <- list(output_folder = "../SpectroPipeR_test_folder")
#'
#'# example input file
#'example_file_path <- system.file("extdata",
#'                                 "SN_test_HYE_mix_file.tsv",
#'                                 package="SpectroPipeR")
#'
#'# step 1: load Spectronaut data module
#'SpectroPipeR_data <- read_spectronaut_module(file = example_file_path,
#'                                       parameter = params,
#'                                       print.plot = FALSE)
#'
#'# step 2: normalize & quantification module
#'SpectroPipeR_data_quant <- norm_quant_module(SpectroPipeR_data = SpectroPipeR_data)

norm_quant_module <- function(SpectroPipeR_data = NULL,
                              batch_adjusting = FALSE,
                              sample__batch_meta_data_file = NULL,
                              batch_adjusting_column = "",
                              number_of_cores_adjusting = parallel::detectCores()-2,
                              covariate_adjusting_formula = "",
                              covariate_adjusting_meta_data_file = "",
                              skipping_MaxLFQ_median_norm = FALSE,
                              costum_colors = NULL,
                              print.plot = FALSE){

  # check if SpectroPipeR_data object was provided
  if(!is(SpectroPipeR_data,"SpectroPipeR_data")){
    stop_text <- paste("no valid SpectroPipeR_data was provided: please load the Spectronaut export via the read_spectronaut_module() to generate one!")
    message_function(text = stop_text,color = "red",log_file_name = log_file_name)
    stop()
  }

  #output folder
  out_folder <- SpectroPipeR_data$parameter$output_folder

  #check parameters
  #parameter_check(parameter)
  parameter_input <- SpectroPipeR_data$parameter
  parameter_input$skipping_MaxLFQ_median_norm <- skipping_MaxLFQ_median_norm
  log_file_name <- SpectroPipeR_data$parameter$log_file_name

  message_function(text = "",
                   color = "white",
                   log_file_name = log_file_name)
  message_function(text = "#*****************************************",
                   color = "white",
                   log_file_name = log_file_name)
  message_function(text = "# NORMALIZATION & QUANTIFICATION MODULE",
                   color = "white",
                   log_file_name = log_file_name)
  message_function(text = "#*****************************************",
                   color = "white",
                   log_file_name = log_file_name)
  message_function(text = "",
                   color = "white",
                   log_file_name = log_file_name)

  #raw_data
  raw_input <- SpectroPipeR_data

  #extract parameter
  parameter <- SpectroPipeR_data$parameter

  #get raw file names
  raw_file_names <- SpectroPipeR_data$raw_file_names

  # get data
  data <- SpectroPipeR_data$spectronaut_output

  message_function(text = "sorting Replicates and conditions ...",
                   color = "blue",
                   log_file_name = log_file_name)

  #sorting data condition + replicates ====
  data <- data %>%
    arrange(.data$R.Condition,
            .data$R.Replicate)

  #if data is not provided
  if(length(data)==0){
    stop_text <- paste("no data selected: wrong input or previous step suggested to redo Spectronaut analysis")
    message_function(text = stop_text,color = "red",log_file_name = log_file_name)
    stop()
  }

  #if batch adjusting is TRUE and no sample_meta_data
  if(batch_adjusting==TRUE & is.null(sample__batch_meta_data_file)){
    stop_text <- paste("no batch meta data file is provided")
    message_function(text = stop_text,color = "red",log_file_name = log_file_name)
    stop()
  }

  #if batch adjusting is TRUE and no sample_meta_data
  if(batch_adjusting==TRUE & batch_adjusting_column==""){
    stop_text <- paste("no batch adjusting column was provided")
    message_function(text = stop_text,color = "red",log_file_name = log_file_name)
    stop()
  }


  if(batch_adjusting==TRUE){
    message_function(text = "BATCH ADJUSTING: load batch meta data file ...",
                     color = "green",
                     log_file_name = log_file_name)

    sample_batch_meta_data <- read_delim(sample__batch_meta_data_file,delim = "\t",col_names = T,show_col_types = FALSE)
    #add paramters to global parameters for report
    parameter_input$batch_adjusting <- batch_adjusting
    parameter_input$batch_adjusting_column <- batch_adjusting_column
    parameter_input$sample_batch_meta_data <- sample__batch_meta_data_file
    #if batch adjusting is TRUE and no sample_meta_data
    if(batch_adjusting==TRUE &
       batch_adjusting_column!="" &
       length(which(colnames(sample_batch_meta_data)==batch_adjusting_column))!=1){
      stop_text <- paste("provided batch_adjusting_column is not in the sample__batch_meta_data_file")
      message_function(text = stop_text,color = "red",log_file_name = log_file_name)
      stop()
    }
  }else{
    parameter_input$batch_adjusting <- FALSE
  }


  #if covariate_adjusting_meta_data_file file was provided but no formula was set
  if(covariate_adjusting_formula=="" &
     covariate_adjusting_meta_data_file!=""){
    stop_text <- paste("no formula was provided for covaribale adjustment;
         use e.g. covariate_adjusting_formula = 'log10_peptide_intensity ~ age + as.factor(sex)'")
    message_function(text = stop_text,color = "red",log_file_name = log_file_name)
    stop()
  }
  #if covariate_adjusting_formula was set but covariate_adjusting_meta_data_file is missing
  if(nchar(covariate_adjusting_formula)!=0 &
     covariate_adjusting_meta_data_file==""){
    stop_text <- paste("no covariate_adjusting_meta_data_file was provided for covaribale adjustment;
         use e.g. covariate_adjusting_meta_data_file = 'covariate_file.csv'")
    message_function(text = stop_text,color = "red",log_file_name = log_file_name)
    stop()
  }

  #if covariate_adjusting_formula was set and covariate_adjusting_meta_data_file is provided load meta file
  if(nchar(covariate_adjusting_formula)!=0 & covariate_adjusting_meta_data_file!=""){

    # add covariate data to paramters
    parameter_input$covariate_adjusting_formula <- covariate_adjusting_formula
    parameter_input$covariate_adjusting_meta_data_file <- covariate_adjusting_meta_data_file

    #### load covariate meta data file
    covaribale_meta_data <- readr::read_csv(file = covariate_adjusting_meta_data_file,show_col_types = FALSE)

    # error if not all raw files have covariate meta data
    if(sum(raw_file_names$R.FileName%in%covaribale_meta_data$R.FileName)!=length(raw_file_names$R.FileName)){
      stop_text <- paste("not all raw files can be found in the provided covariate meta file")
      message_function(text = stop_text,color = "red",log_file_name = log_file_name)
      stop()
    }else{
      #add parameters to global parameters for report
      parameter_input$covariate_adjusting_formula <- covariate_adjusting_formula
      parameter_input$covariate_adjusting_meta_data_file <- covariate_adjusting_meta_data_file
    }
  }

  #### function input check done #####

  #number of samples detected
  sample_length <- length(unique(data$R.FileName))
  condition_length <- length(unique(data$R.Condition))



# setup condition colors --------------------------------------------------

  #colors setup ====
  if(is.null(costum_colors)){
    general.colors <- c("#1B5E20","#C62828","#0D47A1","#4E342E","#E65100","#000000","#6A1B9A","#4F8F00","#89694E","#00695C","#827717","#5E5E5E")
    general.colors.gradient <- colorRampPalette(c("black","#0057e7","#d62d20","#008744","#ffa700","grey"))
    condition_elements_length <- length(unique(data$R.Condition))
    if(condition_elements_length > length(general.colors)){
      condition_colors <- general.colors.gradient(condition_elements_length)
    }else{
      condition_colors <- general.colors[1:condition_elements_length]
    }
    names(condition_colors) <- unique(data$R.Condition)

  }else{
    if(is.vector(costum_colors)==T){
      number_of_conditions <- unique(data$R.Condition)
      if(length(costum_colors)==length(number_of_conditions)){
        message_function(text = "use custom colors ...",
                         color = "green",
                         log_file_name = log_file_name)
        condition_colors <- costum_colors
      }
    }else{
      stop_text <- paste("custom colors is not a valid vector")
      message_function(text = stop_text,color = "red",log_file_name = log_file_name)
      stop()
    }
  }

  # select plot method for normalization factors
  boxplot_norm_factor_logical<- ifelse(test = nrow(data %>%
                                                     distinct(.data$R.FileName,
                                                              .data$R.Condition,
                                                              .data$R.Replicate,
                                                              .data$EG.NormalizationFactor)) > length(unique(data$R.FileName)),
                                       yes = T,
                                       no = F)


  # if normalization was performed inside spectronaut use spectronaut method
  if(sum(data$EG.NormalizationFactor,na.rm = T)!=0){
    message_function(text = "NORMALIZATION WAS DONE IN SPECTRONAUT...",
                     color = "cyan",
                     log_file_name = log_file_name)
    message_function(text = "...skipping normalization step and use Spectronaut normalized data instead...",
                     color = "cyan",
                     log_file_name = log_file_name)

    #use spectronaut output as normalized data since it was normlized inside Spectronaut
    data <- data %>%
      mutate(EG.TotalQuantity.MedianNormalized = .data$`EG.TotalQuantity (Settings)`)

    #norm factor
    MedianNormalizationFactor <-  data %>%
      group_by(.data$R.FileName,
               .data$R.Condition,
               .data$R.Replicate) %>%
      summarise(MedianNormalizationFactor = median(.data$EG.NormalizationFactor,na.rm = T)) %>% # use median for aggregation and for reporting since local normalization is also possible
      ungroup()

    #normalization_outliers
    MedianNormalizationFactor_outlier <- MedianNormalizationFactor[which(abs(log2(MedianNormalizationFactor$MedianNormalizationFactor))>log2(parameter$normalization_factor_cutoff_outlier)),]

    #add outliers indication to list
    MedianNormalizationFactor <- MedianNormalizationFactor %>%
      mutate(normalization_outlier=ifelse(test = .data$R.FileName%in%MedianNormalizationFactor_outlier$R.FileName,
                                          yes = "yes",
                                          no = "no"))

    data <- data %>%
      mutate(`EG.TotalQuantity (Settings)` = .data$`EG.TotalQuantity (Settings)` / .data$EG.NormalizationFactor)

  }else{
    # no spectronaut normalization was performed

    #median normalization over ion signals
    if(parameter$normalization_method=="median"){
      #perform median normalization ====
      message_function(text = "no normalization method WAS selected in SPECTRONAUT...",
                       color = "blue",
                       log_file_name = log_file_name)
      message_function(text = "...performing median normalization...",
                       color = "blue",
                       log_file_name = log_file_name)

      med <- median(data$`EG.TotalQuantity (Settings)`,
                  na.rm = T)

      message_function(text = paste("EG.TotalQuantity (Settings) intensity median =",round(med,digits = 2)),
                       color = "blue",
                       log_file_name = log_file_name)

      data <- data %>%
        dplyr::group_by(.data$R.FileName) %>%
        dplyr::mutate(EG.TotalQuantity.MedianNormalized = .data$`EG.TotalQuantity (Settings)`*(med/median(.data$`EG.TotalQuantity (Settings)`,na.rm=T))) %>%
        ungroup()

      #norm factor
      MedianNormalizationFactor <-  data %>%
        dplyr::group_by(.data$R.FileName,
                        .data$R.Condition,
                        .data$R.Replicate) %>%
        dplyr::summarise(MedianNormalizationFactor = med/median(.data$`EG.TotalQuantity (Settings)`,na.rm=T)) %>%
        ungroup()

      #normalization_outliers
      MedianNormalizationFactor_outlier <- MedianNormalizationFactor[which(abs(log2(MedianNormalizationFactor$MedianNormalizationFactor))>log2(parameter$normalization_factor_cutoff_outlier)),]

      #add outliers indication to list
      MedianNormalizationFactor <- MedianNormalizationFactor %>%
        dplyr::mutate(normalization_outlier=ifelse(test = .data$R.FileName%in%MedianNormalizationFactor_outlier$R.FileName,
                                                   yes = "yes",
                                                   no = "no"))


    }else{ #median normalization selection ELSE
      stop_text <- paste("no valid normalization method selected")
      message_function(text = stop_text,color = "red",log_file_name = log_file_name)
      stop()

    }
  }


    #create file number specific folder
    if(dir.exists(paste0(out_folder,"/","03_normalization/",sample_length,"_sample_analysis"))){
      message(crayon::magenta(paste0(out_folder,"/","03_normalization/",sample_length,"_sample_analysis"," ATTENTION !!! ---> folder already exists - files will be replaced !!!")))
    }else{
      dir.create(paste0(out_folder,"/","03_normalization"),recursive = T,showWarnings = F)
      dir.create(paste0(out_folder,"/","03_normalization/",sample_length,"_sample_analysis"),recursive = T,showWarnings = F)
    }
    if(dir.exists(paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis"))){
      message(crayon::magenta(paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis"," ATTENTION !!! ---> folder already exists - files will be replaced !!!")))
    }else{
      dir.create(paste0(out_folder,"/","05_processed_data"),recursive = T,showWarnings = F)
      dir.create(paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis"),recursive = T,showWarnings = F)
    }
    #write outputs
    write_csv(x = MedianNormalizationFactor,
              file = paste0(out_folder,"/","03_normalization/",sample_length,"_sample_analysis/Median_normalization_factors.csv"))

    #do normalization factor plot ====
    NormFactor_plot <- ggplot(data = MedianNormalizationFactor,
                              mapping = aes(x = .data$R.FileName,
                                  y = log2(.data$MedianNormalizationFactor),
                                  fill = .data$normalization_outlier))+
      geom_bar(stat="identity")+
      theme_light(base_size = 18)+
      theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust = 0.5,size=9))+
      scale_fill_manual(values = c("yes"="orangered","no"="darkgrey"))+
      geom_hline(yintercept = log2(1),linetype="solid",color="darkgrey")+
      geom_hline(yintercept = log2(parameter$normalization_factor_cutoff_outlier),linetype="solid")+
      geom_hline(yintercept = log2(parameter$normalization_factor_cutoff_outlier)*-1,linetype="solid")+
      labs(title="normalization factor plot",
           subtitle = "",
           y=expression(log[2]~"normalization factor"),
           x="raw file name",
           caption=paste("solid line = normlization cutoff of",
                         parameter$normalization_factor_cutoff_outlier,
                         "fold\n difference form median")
      )

    if(boxplot_norm_factor_logical==T){
      NormFactor_BOXplot <- ggplot(data = data,
                                   mapping = aes(x = .data$R.FileName,
                                                 y = log2(.data$EG.NormalizationFactor)))+
        gghalves::geom_half_violin(fill = "grey",side = "l", color = NA,trim = F,scale = "width")+
        gghalves::geom_half_boxplot(outlier.colour = NA,side = "r", fill = "white",errorbar.draw = F)+
        theme_light(base_size = 18)+
        theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust = 0.5,size=9))+
        scale_fill_manual(values = c("yes"="orangered","no"="darkgrey"))+
        geom_hline(yintercept = log2(1),linetype="solid",color="darkgrey")+
        geom_hline(yintercept = log2(parameter$normalization_factor_cutoff_outlier),linetype="solid")+
        geom_hline(yintercept = log2(parameter$normalization_factor_cutoff_outlier)*-1,linetype="solid")+
        labs(title="normalization factor plot",
             subtitle = "",
             y=expression(log[2]~"normalization factor"),
             x="raw file name",
             caption=paste("solid line = normlization cutoff of",
                           parameter$normalization_factor_cutoff_outlier,
                           "fold\n difference form median")
        )

      ggsave_pdf_png(filename = paste0(out_folder,"/","03_normalization/",sample_length,"_sample_analysis/normalization_factor_BOXplot"),
                     plot = NormFactor_BOXplot,
                     limitsize = F,
                     height = 10,
                     width = if((0.2*sample_length)<15){15}else{0.2*sample_length}
      )
    }

    #do normalization boxplot plot ====
    Norm_plot <- data %>%
      dplyr::select(.data$R.FileName,
                    .data$ion,
                    .data$`EG.TotalQuantity (Settings)`,
                    .data$EG.TotalQuantity.MedianNormalized) %>%
      pivot_longer(cols = c("EG.TotalQuantity (Settings)","EG.TotalQuantity.MedianNormalized"),
                   names_to = "data_fraction",
                   values_to = "intensity") %>%
      ggplot(mapping = aes(x = .data$R.FileName,y = .data$intensity))+
        gghalves::geom_half_violin(fill = "grey",side = "r", color = NA,trim = F,scale = "width")+
        gghalves::geom_half_boxplot(outlier.colour = NA, fill = "white",errorbar.draw = F)+
        scale_y_log10()+
        annotation_logticks(sides = "b")+
        facet_wrap(~data_fraction,
                  labeller = labeller(data_fraction = c("EG.TotalQuantity (Settings)" = "raw ion data",
                                                              "EG.TotalQuantity.MedianNormalized" = "norm. ion data")))+
      coord_flip()+
      geom_hline(yintercept = median(data$EG.TotalQuantity.MedianNormalized,na.rm = T), linetype = "dashed")+
      theme_light(base_size = 18)+
      labs(title = "ion intensities",
           subtitle = "raw data vs. norm. data",
           x = "",
           y = "ion intensity")


    #plot if print out == T
    if(print.plot==T){
      print(NormFactor_plot)
    }

    #writeOutputPlots in folder
    message_function(text = "save Normalization factor plot ...",
                     color = "blue",
                     log_file_name = log_file_name)

    ggsave_pdf_png(filename = paste0(out_folder,"/","03_normalization/",sample_length,"_sample_analysis/normalization_factor_plot"),
           plot = NormFactor_plot,
           limitsize = F,
           height = 10,
           width = if((0.2*sample_length)<15){15}else{0.2*sample_length}
             )



    message_function(text = "save Normalization boxplot ...",
                     color = "blue",
                     log_file_name = log_file_name)

    ggsave_pdf_png(filename = paste0(out_folder,"/","03_normalization/",sample_length,"_sample_analysis/normalization_boxplot"),
                   plot = Norm_plot,
                   limitsize = F,
                   height = if((0.2*sample_length)<15){15}else{0.2*sample_length},
                   width = 20
    )

    # adding MC--> CV plots for ion data --------------------------------------------
    message_function(text = "generate ion CV data...",
                     color = "blue",
                     log_file_name = log_file_name)
    # generate ion CV data
    data_ion_cv<- data %>%
      dplyr::group_by(.data$R.Condition,
                      .data$PEP.StrippedSequence,
                      .data$EG.ModifiedPeptide,
                      .data$FG.Charge,
                      .data$PEP.NrOfMissedCleavages) %>%
      summarise(mean = mean(.data$EG.TotalQuantity.MedianNormalized,
                            na.rm = T),
                CV = sd(.data$EG.TotalQuantity.MedianNormalized,
                        na.rm = T) / mean(.data$EG.TotalQuantity.MedianNormalized,
                                          na.rm = T)
                ) %>%
      ungroup()

    CV_plot_ion_global_MC <- ggplot(data = data_ion_cv %>%
                                      dplyr::mutate(CV = ifelse(is.na(.data$CV),-Inf,.data$CV)),
                                    mapping = aes(x = .data$R.Condition,
                                                  y = .data$CV,
                                                  fill= as.factor(.data$PEP.NrOfMissedCleavages) )
                                    )+
      geom_boxplot(outlier.colour = NA)+
      geom_hline(yintercept = 0.1,linetype = "dashed")+
      geom_hline(yintercept = 0.2)+
      theme_light(base_size = 16)+
      scale_fill_brewer(palette = "Set1")+
      theme(axis.text.x = element_blank())+
      labs(title = "ion CV per condition\nand missed cleavages",
           fill = "MC", x = "", y = "coeff. of variation")

    CV_plot_ion_global <- ggplot(data = data_ion_cv %>%
                                   dplyr::mutate(CV = ifelse(is.na(.data$CV),0,.data$CV)) %>%
                                   dplyr::group_by(.data$R.Condition) %>%
                                   dplyr::mutate(color = ifelse(test = sum(.data$CV==0)==n(),
                                                                yes = "invalid",
                                                                no = "valid")) %>%
                                   ungroup(),
                                 mapping = aes(x = .data$R.Condition,
                                               y = .data$CV ))+
      gghalves::geom_half_violin(mapping = aes(fill = .data$color,
                                               alpha = .data$color),
                                 na.rm = TRUE,
                                 side = "l",
                                 color = NA,
                                 trim = F,
                                 scale = "width",
                                 show.legend = F)+
      gghalves::geom_half_boxplot(mapping = aes(color = .data$color,
                                                alpha = .data$color),
                                  outlier.colour = NA,
                                  side = "r",
                                  fill = "white",
                                  errorbar.draw = F,
                                  show.legend = F)+
      geom_hline(yintercept = 0.1,linetype = "dashed")+
      geom_hline(yintercept = 0.2)+
      theme_light(base_size = 16)+
      scale_color_manual(values = c("invalid"= "white", "valid" = "black"))+
      scale_fill_manual(values = c("invalid"= "white", "valid" = "grey"))+
      scale_alpha_manual(values = c("invalid"= 0, "valid" = 1))+
      theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust = 0.5))+
      labs(title = "",
           fill = "MC",
           x = "condition",
           y = "coeff. of variation",
           caption = "all ions")

    CV_plot_ion_condition_wise <- CV_plot_ion_global_MC/CV_plot_ion_global


    message_function(text = "save ion CV data plots...",
                     color = "blue",
                     log_file_name = log_file_name)
    # save condition wise CV per ion
    ggsave_pdf_png(plot = CV_plot_ion_condition_wise,
                   filename = paste0(out_folder,"/","03_normalization/",sample_length,"_sample_analysis/ion_CV_plot"),
                   width = (condition_length*1)+2,
                   height = 10)

    message_function(text = "save ion CV data vs. mean intensity hexbin plots...",
                     color = "blue",
                     log_file_name = log_file_name)

    # missed cleavage plot count global and per file

    # if all CV values = NA --> only 1 replicate per condition
    if(sum(is.na(data_ion_cv$CV))==nrow(data_ion_cv)){

      CV_plot_ion_intensity_per_condition <- ggplot(data = data_ion_cv %>%
                                                      dplyr::mutate(PEP.NrOfMissedCleavages = paste("MC:",.data$PEP.NrOfMissedCleavages)),
                                                    mapping = aes(x = .data$mean,
                                                                  y= .data$CV))+
        scale_alpha_binned(range = c(0.3,1))+
        geom_hline(yintercept = 0.1,linetype = "dashed")+
        geom_hline(yintercept = 0.2)+
        theme_light(base_size = 18)+
        scale_fill_distiller(palette = "Spectral")+
        facet_grid(.data$PEP.NrOfMissedCleavages ~ .data$R.Condition)+
        scale_x_log10()+
        theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust = 0.5))+
        labs(title = "ion CV per condition and missed cleavages",
             color = "MC",
             x = "norm. ion intensity",
             y = "coeff. of variation",
             caption = "dashed line = CV of 0.1; solid line = CV of 0.2")
    }else{
      CV_plot_ion_intensity_per_condition <- ggplot(data = data_ion_cv %>%
                                                      dplyr::mutate(PEP.NrOfMissedCleavages = paste("MC:",.data$PEP.NrOfMissedCleavages)),
                                                    mapping = aes(x = .data$mean,
                                                                  y= .data$CV))+
        geom_hex(aes(alpha = after_stat(count)))+
        scale_alpha_binned(range = c(0.3,1))+
        geom_hline(yintercept = 0.1,linetype = "dashed")+
        geom_hline(yintercept = 0.2)+
        theme_light(base_size = 18)+
        scale_fill_distiller(palette = "Spectral")+
        facet_grid(.data$PEP.NrOfMissedCleavages ~ .data$R.Condition)+
        scale_x_log10()+
        theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust = 0.5))+
        labs(title = "ion CV per condition and missed cleavages",
             color = "MC",
             x = "norm. ion intensity",
             y = "coeff. of variation",
             caption = "dashed line = CV of 0.1; solid line = CV of 0.2")
    }

    # save plot CV_plot_ion_intensity_per_condition
    ggsave_pdf_png(plot = CV_plot_ion_intensity_per_condition,
                   filename = paste0(out_folder,"/","03_normalization/",sample_length,"_sample_analysis/ion_intenisty_vs_CV_hexbin_plot"),
                   width = (condition_length*5)+2,
                   height = 12)



    #generating quantitative data of peptides and proteins ====
    message_function(text = "calculating peptide intensity data ...",
                     color = "blue",
                     log_file_name = log_file_name)
    raw_peptides <- data %>%
      dplyr::group_by(.data$R.FileName,
                      .data$R.Replicate,
                      .data$R.Condition,
                      .data$PG.ProteinGroups,
                      .data$EG.ModifiedPeptide,
                      .data$PEP.StrippedSequence) %>%
      dplyr::summarise(peptide_intensity = sum(.data$EG.TotalQuantity.MedianNormalized, na.rm = T)) %>%
      ungroup()

    message_function(text = "writing peptide intensity data ...",
                     color = "blue",
                     log_file_name = log_file_name)

    write_csv(x = raw_peptides,
              file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/peptide_intensities.csv"))


    #filter for methionine oxidation ====
    if(parameter$filter_oxidized_peptides==T){
      message_function(text = "filter Met_oxidized peptides ... TRUE",
                       color = "blue",
                       log_file_name = log_file_name)

      raw_peptides_filtered_without_metOx <- raw_peptides %>%
        dplyr::filter(!grepl(pattern = "Oxidation \\(M)",.data$EG.ModifiedPeptide))

      raw_peptides_filtered_without_metOx_number <- length(unlist(raw_peptides %>%
                                                                    dplyr::filter(grepl(pattern = "Oxidation \\(M)",.data$EG.ModifiedPeptide)) %>%
                                                                    distinct(.data$EG.ModifiedPeptide)))

      write_csv(x = raw_peptides_filtered_without_metOx,
                file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/peptide_intensities_without_Met_oxidized_peptides.csv"))

      peptide_intensity <- raw_peptides_filtered_without_metOx

      message_function(text = paste(raw_peptides_filtered_without_metOx_number,"Met_oxidized peptides filtered for quantification"),
                       color = "blue",
                       log_file_name = log_file_name)
    }else{
      peptide_intensity <- raw_peptides
    }


    #replacing 0 values with half-maximal values ====
    if(length(which(peptide_intensity$peptide_intensity==0))>0){

      #half-minimal value
      min_non_zero_int_value<- min(peptide_intensity$peptide_intensity[which(peptide_intensity$peptide_intensity!=0)])
      message_function(text = paste("replacing",length(which(peptide_intensity$peptide_intensity==0))/nrow(peptide_intensity)*100,"% of values (ZERO quantity values)"),
                       color = "blue",
                       log_file_name = log_file_name)
      message_function(text = paste("with",min_non_zero_int_value/2,"= half-minimal value"),
                                    color = "blue",
                                    log_file_name = log_file_name)

      #replace 0 value
      peptide_intensity$peptide_intensity[peptide_intensity$peptide_intensity==0] <- min_non_zero_int_value/2

      #write final peptide table
      write_csv(x = peptide_intensity,
                file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/peptide_intensities_final_zero_values_replaced_with_half_minimal_intensity.csv"))
    }else{

      #write final peptide table
      write_csv(x = peptide_intensity,
                file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/peptide_intensities_final.csv"))
    }


    # Batch adjustment with ComBat --------------------------------------------
    if(batch_adjusting == T){

      # sample_batch_meta_data: convert R.FileName to R.FileName capped for joining
      sample_batch_meta_data<- left_join(raw_file_names %>%
                                                       dplyr::select(.data$R.FileName,
                                                                     .data$R.FileName_raw),
                                                     sample_batch_meta_data,
                                                     by = c("R.FileName_raw"="R.FileName")) %>%
        dplyr::select(-.data$R.FileName_raw)

      # if R.FileName could not be matched at all
      if(sum(is.na(sample_batch_meta_data[,which(colnames(sample_batch_meta_data)==batch_adjusting_column)])) == nrow(sample_batch_meta_data)){
        stop_text <- paste0("Batch adjusting failed because ",batch_adjusting_column," column could not be matched via R.FileName column; R.FileName column missing or wrong file names")
        message_function(text = stop_text,color = "red",log_file_name = log_file_name)
        stop()

      }

      ########################################## prepare data for Batch adjustment##########################################
      peptide_intensity_batch_adjusted <- peptide_intensity %>%
        dplyr::filter(.data$R.FileName %in% sample_batch_meta_data$R.FileName)

      #input_batch = batch numbering of colnames form input_data_ComBat
      input_data_removeBatchEffect_log2 <-  peptide_intensity_batch_adjusted %>%
        tidyr::unite(.data$PG.ProteinGroups,
                     .data$EG.ModifiedPeptide,
                     col = "PG.ProteinGroups_EG.ModifiedPeptide",
                     sep="_|_") %>%
        dplyr::select(.data$PG.ProteinGroups_EG.ModifiedPeptide,
                      .data$R.FileName,
                      .data$peptide_intensity) %>%
        dplyr::mutate(peptide_intensity=log2(.data$peptide_intensity)) %>% #do log2 transformation of data for batch effect adjustment
        pivot_wider(names_from = .data$R.FileName,values_from = .data$peptide_intensity) %>%
        as.data.frame()

      rownames(input_data_removeBatchEffect_log2) <- input_data_removeBatchEffect_log2$PG.ProteinGroups_EG.ModifiedPeptide

      input_data_removeBatchEffect_log2 <- input_data_removeBatchEffect_log2[,-1]

      #batch input
      input_batch <- unlist(sapply(colnames(input_data_removeBatchEffect_log2),
                                   function(x) sample_batch_meta_data[which(sample_batch_meta_data$R.FileName==x),batch_adjusting_column]))


      # workaround if R.FileName provided is the long uncapped form
      if(dim(input_data_removeBatchEffect_log2)[1]==0){
        sample_batch_meta_data_alternative<- left_join(raw_file_names %>%
                                                        dplyr::select(.data$R.FileName,
                                                                      .data$R.FileName_raw),
                                                       sample_batch_meta_data,
                                                       by = c("R.FileName_raw"="R.FileName")) %>%
                                                  dplyr::select(-.data$R.FileName_raw)
        # replace existing sample_batch_meta_data
        sample_batch_meta_data <- sample_batch_meta_data_alternative

        peptide_intensity_batch_adjusted <- peptide_intensity %>%
          dplyr::filter(.data$R.FileName%in%sample_batch_meta_data$R.FileName)

        #input_batch = batch numbering of colnames form input_data_ComBat
        input_data_removeBatchEffect_log2 <-  peptide_intensity_batch_adjusted %>%
          tidyr::unite(.data$PG.ProteinGroups,
                       .data$EG.ModifiedPeptide,
                       col = "PG.ProteinGroups_EG.ModifiedPeptide",sep="_|_") %>%
          dplyr::select(.data$PG.ProteinGroups_EG.ModifiedPeptide,
                        .data$R.FileName,
                        .data$peptide_intensity) %>%
          dplyr::mutate(peptide_intensity=log2(.data$peptide_intensity)) %>% #do log2 transformation of data for batch effect adjustment
          pivot_wider(names_from = .data$R.FileName,values_from = .data$peptide_intensity) %>%
          as.data.frame()

        rownames(input_data_removeBatchEffect_log2) <- input_data_removeBatchEffect_log2$PG.ProteinGroups_EG.ModifiedPeptide

        input_data_removeBatchEffect_log2 <- input_data_removeBatchEffect_log2[,-1]

        #batch input
        input_batch <- unlist(sapply(colnames(input_data_removeBatchEffect_log2),
                                     function(x) sample_batch_meta_data[which(sample_batch_meta_data$R.FileName==x),batch_adjusting_column]))

      }

      # if sample meta still empty
      if(dim(input_data_removeBatchEffect_log2)[1]==0 | length(input_batch)==0){
        stop_text <- paste("R.FileName of sample__batch_meta_data_file could not been matched to the raw data file")
        message_function(text = stop_text,color = "red",log_file_name = log_file_name)
        stop()
      }




      ########################################## remove Batch effect sva ComBat removeBatchEffect ##########################################
      message_function(text = "BATCH adjusting....",color = "blue",log_file_name = log_file_name)
      message_function(text = "this might take a while...",color = "blue",log_file_name = log_file_name)
      message_function(text = "<------processing------>",color = "blue",log_file_name = log_file_name)
      message_function(text = "mod == NULL --> no Model matrix for outcome of interest and other covariates besides batch",color = "blue",log_file_name = log_file_name)
      message_function(text = "mean.only == FALSE --> ComBat DOES NOT only corrects the mean of the batch effect (no scale adjustment)",color = "blue",log_file_name = log_file_name)
      message_function(text = "ref.batch == NULL --> no reference batch provided",color = "blue",log_file_name = log_file_name)
      message_function(text = "par.prior == T --> TRUE indicates parametric adjustments will be used",color = "blue",log_file_name = log_file_name)

      #do batch adjustment
      output_ComBat_BatchEffects <- sva::ComBat(dat = as.matrix(input_data_removeBatchEffect_log2),
                                                batch = input_batch,
                                                mod = NULL,
                                                par.prior = T,
                                                prior.plots = T,
                                                mean.only = F,
                                                ref.batch = NULL,
                                                BPPARAM = BiocParallel::MulticoreParam(number_of_cores_adjusting))

      message_function(text = "<--------DONE-------->",color = "blue",log_file_name = log_file_name)


      ########################################## output of batch adjusted data ##########################################
      message_function(text = "tidy data",color = "blue",log_file_name = log_file_name)

      output_ComBat_BatchEffects_tibble <- tibble::as_tibble(output_ComBat_BatchEffects)
      output_ComBat_BatchEffects_tibble$tmp <- rownames(output_ComBat_BatchEffects)
      output_ComBat_BatchEffects_tibble <- output_ComBat_BatchEffects_tibble %>%
        tidyr::separate(col = .data$tmp,
                        into = c("PG.ProteinGroups","EG.ModifiedPeptide"),
                        sep = "_\\|_",
                        remove = T)
      output_ComBat_BatchEffects_tibble <- bind_cols(output_ComBat_BatchEffects_tibble[,c("PG.ProteinGroups","EG.ModifiedPeptide")],
                                                     output_ComBat_BatchEffects_tibble %>%
                                                       dplyr::select(-.data$PG.ProteinGroups,
                                                                     -.data$EG.ModifiedPeptide))
      output_ComBat_BatchEffects_tibble[,-c(1,2)] <- apply(X = output_ComBat_BatchEffects_tibble[,-c(1,2)],
                                                           MARGIN = 2,
                                                           FUN = function(x) as.numeric(2^x)
                                                           )


      message_function(text = "save batch adjusted data",color = "blue",log_file_name = log_file_name)

      #write batch adjusted output
      write_csv(x = output_ComBat_BatchEffects_tibble,
                file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/peptide_intensities_final_BATCH_adjusted_WIDE_FORMAT.csv"))

      message_function(text = "joining peptide data",color = "blue",log_file_name = log_file_name)

      peptide_intensity_ComBat <- output_ComBat_BatchEffects_tibble %>%
                                    pivot_longer(cols = colnames(output_ComBat_BatchEffects_tibble)[-c(1:2)],
                                           names_to = "R.FileName",
                                           values_to = "batch_adjusted_peptide_intensity"
                                           )

      #joining unadjusted and adjusted peptide_intensity
      peptide_intensity <- left_join(peptide_intensity,
                                     peptide_intensity_ComBat,
                                     by = c("PG.ProteinGroups","EG.ModifiedPeptide","R.FileName"))
      write_csv(x = peptide_intensity,
                  file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/peptide_intensities_final_BATCH_adjustment_unadjusted_and_adjusted.csv"))


      #TEST PLOTS BATCH ADJUSTING
      # ggplot(peptide_intensity,aes(peptide_intensity,batch_adjusted_peptide_intensity))+
      #   geom_point()+
      #   facet_wrap(~R.FileName)+
      #   scale_y_log10()+
      #   scale_x_log10()+
      #   geom_abline(slope = 1,intercept = 0,color="red")


      #ggplot(peptide_intensity,aes(R.FileName,batch_adjusted_peptide_intensity))+geom_boxplot()+scale_y_log10()
      #ggplot(peptide_intensity,aes(R.FileName,peptide_intensity))+geom_boxplot()+scale_y_log10()

      # PCA before and after batch adjustment 1:5 dimension ====
      message_function(text = "performing PCA analysis before and after batch adjustment (peptide level)",color = "blue",log_file_name = log_file_name)

      #color setup
      general.colors<-c("#1B5E20","#C62828","#0D47A1","#4E342E","#E65100","#000000","#6A1B9A","#4F8F00","#89694E","#00695C","#827717","#5E5E5E")
      general.colors.gradient<-colorRampPalette(c("black","#0057e7","#d62d20","#008744","#ffa700","grey"))

      #generate habil
      habil <- peptide_intensity %>%
                dplyr::distinct(.data$R.Condition,.data$R.FileName) %>%
                dplyr::arrange(.data$R.Condition)

      #join with additional parameters
      habil <- left_join(habil,
                         sample_batch_meta_data,
                         by="R.FileName")

      colnames(habil) <- str_replace_all(colnames(habil)," ","_")

      for(i in 1:ncol(habil)){
        if(length(unique(unlist(habil[,i])))<=length(general.colors)){
          habil[,i] <- factor(unlist(habil[,i]),levels = unique(unlist(habil[,i])))
        }
      }


      #PCA analysis on peptide level ====
      peptide_data_PCA   <-   peptide_intensity %>%
        dplyr::select(.data$R.FileName,
                      .data$EG.ModifiedPeptide,
                      .data$peptide_intensity) %>%
        pivot_wider(names_from = .data$EG.ModifiedPeptide,
                    values_from = .data$peptide_intensity)

      peptide_data_PCA <- as.data.frame(peptide_data_PCA)
      rownames(peptide_data_PCA)<-peptide_data_PCA$R.FileName #set rownames
      peptide_data_PCA <- peptide_data_PCA[,-1] #remove file name column
      peptide_data_PCA_res <-  PCA(log2(peptide_data_PCA), graph=FALSE,scale.unit=T,ncp = 10)
      write_rds(x = peptide_data_PCA_res,
                file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/PCA_analysis__peptide_level_before_BATCH_adjustment.RDS"))

      peptide_batch_adjusted_data_PCA   <-   peptide_intensity %>%
        dplyr::select(.data$R.FileName,
                      .data$EG.ModifiedPeptide,
                      .data$batch_adjusted_peptide_intensity) %>%
        pivot_wider(names_from = .data$EG.ModifiedPeptide,
                    values_from = .data$batch_adjusted_peptide_intensity)

      peptide_batch_adjusted_data_PCA <- as.data.frame(peptide_batch_adjusted_data_PCA)
      rownames(peptide_batch_adjusted_data_PCA)<-peptide_batch_adjusted_data_PCA$R.FileName #set rownames

      peptide_batch_adjusted_data_PCA <- peptide_batch_adjusted_data_PCA[,-1] #remove file name column

      peptide_batch_adjusted_data_PCA_res <-  PCA(log2(peptide_batch_adjusted_data_PCA),
                                                  graph=FALSE,
                                                  scale.unit=T,
                                                  ncp = 10)

      write_rds(x = peptide_batch_adjusted_data_PCA_res,
                file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/PCA_analysis__peptide_level_after_BATCH_adjustment.RDS"))


        #prepare data for ggpairs
        peptide_PCA_1_to_5dim <- as.data.frame(peptide_data_PCA_res$ind$coord)[,1:5]
        peptide_PCA_1_to_5dim$R.FileName <- rownames(peptide_PCA_1_to_5dim)
        peptide_PCA_1_to_5dim <- left_join(tibble::as_tibble(peptide_PCA_1_to_5dim),
                                           habil,
                                           by="R.FileName") %>%
          dplyr::select(-.data$R.FileName)


        batch_adjusted_peptide_PCA_1_to_5dim <- as.data.frame(peptide_batch_adjusted_data_PCA_res$ind$coord)[,1:5]
        batch_adjusted_peptide_PCA_1_to_5dim$R.FileName <- rownames(batch_adjusted_peptide_PCA_1_to_5dim)
        batch_adjusted_peptide_PCA_1_to_5dim <- left_join(tibble::as_tibble(batch_adjusted_peptide_PCA_1_to_5dim),
                                                          habil,
                                                          by="R.FileName") %>%
          dplyr::select(-.data$R.FileName)

        #setup condition colors

        conditions <- colnames(habil %>%
                                 dplyr::select(-.data$R.FileName))

        message_function(text = "plotting PCAs .... this might take a while",color = "blue",log_file_name = log_file_name)

        for(i in 1:length(conditions)){

          #setup colors
          condition_elements_length<-length(unique(unlist(peptide_PCA_1_to_5dim[,conditions[i]])))

          if(condition_elements_length>length(general.colors)){

            condition_colors<-general.colors.gradient(condition_elements_length)

          }else{

            condition_colors<-general.colors[1:condition_elements_length]

          }

          names(condition_colors) <- unique(unlist(peptide_PCA_1_to_5dim[,conditions[i]]))


          #get habil_classes
          habil_classes<- habil %>%
            dplyr::summarise_all(class) %>%
            tidyr::pivot_longer(everything(),names_to = "variable", values_to = "class")

          #switch from factorial to numerical color gradient
          if(unlist(habil_classes %>%
                    dplyr::filter(.data$variable==conditions[i]) %>%
                    dplyr::select(class))!="numeric"){

            #peptide ggpairs plot 1-5 dim.
            ggplotPCA_peptide_PCA_1_to_5dim <- ggpairs(data = peptide_PCA_1_to_5dim,
                                                       columns = 1:5,
                                                       legend = c(1,1), #legend form sencond row and first column
                                                       title = paste(conditions[i]," - ","PCA 1st to 5th dim. (before batch adj. peptide level)",sep=""),
                                                       mapping = aes_string(color=conditions[i],
                                                                            fill=conditions[i]),
                                                       upper  = list(continuous = "blank"),
                                                       lower = list(continuous = function(data, mapping, ...) {
                                                         ggally_points(data = data, mapping = mapping, alpha = .8,size=4) +
                                                           scale_colour_manual(values = condition_colors)+
                                                           geom_vline(xintercept = 0,linetype="dotted")+
                                                           geom_hline(yintercept = 0,linetype="dotted")
                                                       }
                                                       ),
                                                       diag = list(continuous = function(data, mapping, ...) {
                                                         ggplot(data = data, mapping = mapping)+
                                                           geom_density(alpha = .4) +
                                                           scale_colour_manual(values = condition_colors) +
                                                           scale_fill_manual(values = condition_colors)
                                                       }
                                                       )
            )+
              theme_bw(base_size = 18)+
              theme(legend.position = "right")

            ggplotPCA_adj_peptide_PCA_1_to_5dim <- ggpairs(data = batch_adjusted_peptide_PCA_1_to_5dim,
                                                           columns = 1:5,
                                                           legend = c(1,1), #legend form sencond row and first column
                                                           title = paste(conditions[i]," - ","PCA 1st to 5th dim. (batch adj. peptide level)",sep=""),
                                                           mapping = aes_string(color=conditions[i],fill=conditions[i]),
                                                           upper  = list(continuous = "blank"),
                                                           lower = list(continuous = function(data, mapping, ...) {
                                                             ggally_points(data = data, mapping = mapping, alpha = .8,size=4) +
                                                               scale_colour_manual(values = condition_colors)+
                                                               geom_vline(xintercept = 0,linetype="dotted")+
                                                               geom_hline(yintercept = 0,linetype="dotted")
                                                           }
                                                           ),
                                                           diag = list(continuous = function(data, mapping, ...) {
                                                             ggplot(data = data, mapping = mapping)+geom_density(alpha = .4) +
                                                               scale_colour_manual(values = condition_colors) +
                                                               scale_fill_manual(values = condition_colors)
                                                           }
                                                           )
            )+
              theme_bw(base_size = 18)+
              theme(legend.position = "right")

            ggsave_pdf_png(plot = ggplotPCA_peptide_PCA_1_to_5dim,
                           filename = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/PCA_plot_1st_to_5th_dimension__before_BATCH_adj_peptide_level__",conditions[i]),
                           width = 20,
                           height = 15)
            ggsave_pdf_png(plot = ggplotPCA_adj_peptide_PCA_1_to_5dim,
                           filename = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/PCA_plot_1st_to_5th_dimension__BATCH_ADJUSTED_peptide_level__",conditions[i]),
                           width = 20,
                           height = 15)



          }else{
            #peptide ggpairs plot 1-5 dim.

            # Define a custom function for the lower plot
            lowerFn <- function(data, mapping, ...) {
              p <- ggplot(data = data, mapping = mapping) +
                geom_point(aes(color = UQ(as.name(conditions[i]))), alpha = .8,size=4) +
                scale_color_distiller(palette = "Spectral")+
                geom_vline(xintercept = 0,linetype="dotted")+
                geom_hline(yintercept = 0,linetype="dotted")
              p
            }

            ggplotPCA_peptide_PCA_1_to_5dim <- ggpairs(
              data = peptide_PCA_1_to_5dim,
              columns = 1:5,
              legend = c(2,1), #legend form sencond row and first column
              title = paste(conditions[i]," - ","PCA 1st to 5th dim. (peptide level)",sep=""),
              lower = list(continuous = GGally::wrap(lowerFn))
            )+
              theme_bw(base_size = 18)+
              theme(legend.position = "right")

            ggplotPCA_adj_peptide_PCA_1_to_5dim <- ggpairs(
              data = batch_adjusted_peptide_PCA_1_to_5dim,
              columns = 1:5,
              legend = c(2,1), #legend form sencond row and first column
              title = paste(conditions[i]," - ","PCA 1st to 5th dim. (batch adj. peptide level)",sep=""),
              lower = list(continuous = GGally::wrap(lowerFn))
            )+
              theme_bw(base_size = 18)+
              theme(legend.position = "right")


            ggsave_pdf_png(plot = ggplotPCA_peptide_PCA_1_to_5dim,
                           filename = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/PCA_plot_1st_to_5th_dimension__before_BATCH_ADJUSTED_peptide_level__",conditions[i]),
                           width = 20,
                           height = 15)
            ggsave_pdf_png(plot = ggplotPCA_adj_peptide_PCA_1_to_5dim,
                           filename = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/PCA_plot_1st_to_5th_dimension__BATCH_ADJUSTED_peptide_level__",conditions[i]),
                           width = 20,
                           height = 15)


          }




        }

        message_function(text = "End of Batch adjusting process ...",color = "blue",log_file_name = log_file_name)

        # overwrite peptide_intensity
        peptide_intensity_batch_adjusted <- peptide_intensity
        peptide_intensity <- peptide_intensity %>%
          dplyr::select(-.data$peptide_intensity) %>%
          dplyr::rename(peptide_intensity = .data$batch_adjusted_peptide_intensity)

        }else{# if batchadjustment YES or NO

        peptide_intensity_batch_adjusted <- NULL
      } # END: batch adjusting ====


  # adjusting peptide intensities for covariates ---------------------------

    if(nchar(covariate_adjusting_formula)!=0 & covariate_adjusting_meta_data_file!=""){
      message_function(text = "peptide level covariate adjusting (this might take a while) ...",color = "blue",log_file_name = log_file_name)

      # detect R.FileName R.FileName_raw R.Condition R.Replicate in covariate file
      # colnames(covaribale_meta_data)%nin%c("R.FileName", "R.FileName_raw", "R.Condition", "R.Replicate")


      # adjusting peptide intensities for covariates: save overview of covariates in processed data using summarytools package ----
      summarytools::view(summarytools::dfSummary(covaribale_meta_data[,colnames(covaribale_meta_data)%nin%c("R.FileName", "R.FileName_raw", "R.Condition", "R.Replicate")]),
                         file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/covariates_table_overview.html"))


      # use covariable R.FileName to join to R.FileName capped
      covaribale_meta_data<- left_join(raw_file_names %>%
                                                       dplyr::select(.data$R.FileName,
                                                                     .data$R.FileName_raw),
                                                     covaribale_meta_data,
                                                     by = c("R.FileName_raw"="R.FileName")) %>%
        dplyr::select(-.data$R.FileName_raw)


      # e.g. formula = "log10_peptide_intensity ~ log10(CRP)"
      # add covariate table and perform log10 transformation of peptide intensity data
      peptide_intensity_covariate<- left_join(peptide_intensity,
                                               covaribale_meta_data[,colnames(covaribale_meta_data)%nin%c("R.Condition", "R.Replicate")], #remove redundant colnames
                                               by = c("R.FileName")) %>%
        #perform log10 transformation of peptide intensity
        dplyr::mutate(log10_peptide_intensity = log10(.data$peptide_intensity))

      #generate model for fit
      covariate_model <- function(df) {
        stats::lm(as.formula(covariate_adjusting_formula), data = df)
      }

      #adjusting peptide intensity data for covariates using user formula
      peptide_intensity_covariate_model<- peptide_intensity_covariate %>%
        dplyr::group_by(.data$PG.ProteinGroups,
                        .data$EG.ModifiedPeptide) %>%
        tidyr::nest() %>%
        dplyr::mutate(model = purrr::map(.x = .data$data,
                                         .f = covariate_model)) %>%
        dplyr::mutate(residuals = purrr::map2(.x = .data$data,
                                              .y = .data$model,
                                              .f = modelr::add_residuals))

      # write covaribale adjusted peptide model file
      message_function(text = "write peptide level covariate model file ...",color = "blue",log_file_name = log_file_name)
      write_rds(x = peptide_intensity_covariate_model,
                file = paste0(out_folder,"/","05_processed_data/",
                              sample_length,
                              "_sample_analysis/peptide_intensities_final_covariate_MODEL.RDS")
      )

      # get residuals and add mean of peptide to get the corrected peptide intensity space
      peptide_intensity_covariate_adjusted <- peptide_intensity_covariate_model %>%
        dplyr::select(-.data$model,-.data$data) %>%
        unnest(cols = c("residuals")) %>%
        dplyr::group_by(.data$PG.ProteinGroups,
                        .data$EG.ModifiedPeptide) %>%
        dplyr::mutate(log10_adj_peptide_intensity = .data$resid + mean(.data$log10_peptide_intensity,na.rm = T)) %>%
        dplyr::mutate(peptide_intensity_covariate_adjusted = 10^.data$log10_adj_peptide_intensity) %>%
        ungroup()




      # broom tidy extract of model data using glance
      message_function(text = "extract peptide level covariate adjusting model summary ...",color = "blue",log_file_name = log_file_name)

      peptide_intensity_covariate_adjusted_model_summary <- peptide_intensity_covariate_model %>%
        dplyr::select(-.data$data,-.data$residuals) %>%
        dplyr::group_by(.data$PG.ProteinGroups,
                        .data$EG.ModifiedPeptide) %>%
        dplyr::mutate(glance = purrr::map(.x = .data$model,
                                          .f = broom::glance)) %>%
        tidyr::unnest(glance) %>%
        dplyr::select(-.data$model)

      #write model summary file
      message_function(text = "write peptide level covariate model file paramter file ...",color = "blue",log_file_name = log_file_name)

      write_csv(x = peptide_intensity_covariate_adjusted_model_summary,
                file = paste0(out_folder,"/","05_processed_data/",
                              sample_length,
                              "_sample_analysis/peptide_intensities_final_covariate_MODEL_SUMMARY.csv")
      )


      # sort table
      peptide_intensity_covariate_adjusted <- peptide_intensity_covariate_adjusted %>%
        dplyr::select(.data$R.FileName,
                      .data$R.Replicate,
                      .data$R.Condition,
                      .data$PG.ProteinGroups,
                      .data$EG.ModifiedPeptide,
                      .data$PEP.StrippedSequence,
                      .data$peptide_intensity,
                      .data$peptide_intensity_covariate_adjusted,
                      .data$log10_peptide_intensity,
                      .data$log10_adj_peptide_intensity,
                      everything())

      # write adjusted peptide intensity out
      write_csv(x = peptide_intensity_covariate_adjusted,
                file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/peptide_intensities_final_covariate_unadjusted__and__adjusted.csv"))

      # PCA before and after covariate adjustment 1:5 dimension ====
      message_function(text = "performing PCA analysis before and after covariate adjustment (peptide level)",color = "blue",log_file_name = log_file_name)

      #color setup
      general.colors <- c("#1B5E20","#C62828","#0D47A1","#4E342E","#E65100","#000000","#6A1B9A","#4F8F00","#89694E","#00695C","#827717","#5E5E5E")
      general.colors.gradient <- colorRampPalette(c("black","#0057e7","#d62d20","#008744","#ffa700","grey"))

      #generate habil
      habil <- peptide_intensity %>%
        dplyr::distinct(.data$R.Condition,
                        .data$R.FileName) %>%
        dplyr::arrange(.data$R.Condition)
      #join with additional parameters
      habil <- dplyr::left_join(habil,
                                covaribale_meta_data, by = "R.FileName")
      colnames(habil) <- str_replace_all(colnames(habil)," ","_")

      for(i in 1:ncol(habil)){
        if(length(unique(unlist(habil[,i])))<=length(general.colors)){
          habil[,i] <- factor(unlist(habil[,i]),levels = unique(unlist(habil[,i])))
        }
      }

      #select covariates by class
      factor_covariates<- habil %>%
        dplyr::select(-.data$R.Condition,
                      -.data$R.FileName) %>%
        dplyr::select_if(function(column) is.factor(column))

      if(dim(factor_covariates)[2]>0){
        factor_covariates_names <- colnames(factor_covariates)
      }else{
        factor_covariates_names <- NULL
      }


      numeric_covariates<- habil %>%
        dplyr::select(-.data$R.Condition,
                      -.data$R.FileName) %>%
        dplyr::select_if(function(column) is.numeric(column))

      if(dim(numeric_covariates)[2]>0){
        numeric_covariates_names <- colnames(numeric_covariates)
      }else{
        numeric_covariates_names <- NULL
      }

      #PCA analysis on peptide level ====
      peptide_data_PCA   <-   peptide_intensity_covariate_adjusted %>%
        dplyr::select(-.data$PEP.StrippedSequence,
                      -.data$log10_adj_peptide_intensity,
                      -.data$log10_peptide_intensity,
                      -.data$peptide_intensity_covariate_adjusted,
                      -.data$R.Condition,
                      -.data$R.Replicate,
                      -.data$PG.ProteinGroups,
                      -.data$resid
                      ) %>%
        tidyr::pivot_wider(names_from = .data$EG.ModifiedPeptide,
                           values_from = .data$peptide_intensity)

      peptide_data_PCA <- as.data.frame(peptide_data_PCA)
      rownames(peptide_data_PCA)<-peptide_data_PCA$R.FileName #set rownames
      peptide_data_PCA <- peptide_data_PCA[,-1] #remove file name column
      peptide_data_PCA_res <-  FactoMineR::PCA(log2(peptide_data_PCA),
                                               graph=FALSE,
                                               scale.unit=T,
                                               ncp = 10,
                                               quanti.sup = numeric_covariates_names,
                                               quali.sup = factor_covariates_names,
                                               )

      #if quanti sup is present
      if(sum(names(peptide_data_PCA_res)=="quanti.sup")==1){
        quanti_sup_tibble<- dplyr::bind_rows(
          tibble::as_tibble(t(peptide_data_PCA_res$quanti.sup$coord)) %>%
            mutate(dimensions = rownames(t(peptide_data_PCA_res$quanti.sup$coord)),
                                         parameter = "coordinates"),
          tibble::as_tibble(t(peptide_data_PCA_res$quanti.sup$cor)) %>%
            mutate(dimensions = rownames(t(peptide_data_PCA_res$quanti.sup$cor)),
                   parameter = "correlation_between_variables_and_axes"),
          tibble::as_tibble(t(peptide_data_PCA_res$quanti.sup$cos2)) %>%
            mutate(dimensions = rownames(t(peptide_data_PCA_res$quanti.sup$cos2)),
                   parameter = "cos2")
        ) %>%
          mutate(fraction = "unadjusted")
      }

      #if quali sup is present
      if(sum(names(peptide_data_PCA_res)=="quali.sup")==1){
        quali_sup_tibble<- dplyr::bind_rows(
          tibble::as_tibble(t(peptide_data_PCA_res$quali.sup$coord)) %>%
            mutate(dimensions = rownames(t(peptide_data_PCA_res$quali.sup$coord)),
                   parameter = "coordinates"),
          tibble::as_tibble(t(peptide_data_PCA_res$quali.sup$cos2)) %>%
            mutate(dimensions = rownames(t(peptide_data_PCA_res$quali.sup$cos2)),
                   parameter = "cos2")
        ) %>%
          mutate(fraction = "unadjusted")

      }


      write_rds(x = peptide_data_PCA_res,
                file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/PCA_analysis__peptide_level_before_covariate_adjustment.RDS"))

      peptide_covariate_adjusted_data_PCA   <-   peptide_intensity_covariate_adjusted %>%
        dplyr::select(-.data$PEP.StrippedSequence,
                      -.data$log10_adj_peptide_intensity,
                      -.data$log10_peptide_intensity,
                      -.data$peptide_intensity,
                      -.data$R.Condition,
                      -.data$R.Replicate,
                      -.data$PG.ProteinGroups,
                      -.data$resid
        ) %>%
        tidyr::pivot_wider(names_from = .data$EG.ModifiedPeptide,
                           values_from = .data$peptide_intensity_covariate_adjusted)

      peptide_covariate_adjusted_data_PCA <- as.data.frame(peptide_covariate_adjusted_data_PCA)
      rownames(peptide_covariate_adjusted_data_PCA)<-peptide_covariate_adjusted_data_PCA$R.FileName #set rownames
      peptide_covariate_adjusted_data_PCA <- peptide_covariate_adjusted_data_PCA[,-1] #remove file name column

      peptide_covariate_adjusted_data_PCA_res <-  FactoMineR::PCA(log2(peptide_covariate_adjusted_data_PCA),
                                                                   graph=FALSE,
                                                                   scale.unit=T,
                                                                   ncp = 10,
                                                                   quanti.sup = numeric_covariates_names,
                                                                   quali.sup = factor_covariates_names,
                                                              )



      write_rds(x = peptide_covariate_adjusted_data_PCA_res,
                file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/PCA_analysis__peptide_level_after_covariate_adjustment.RDS"))

      #if quanti sup is present
      if(sum(names(peptide_covariate_adjusted_data_PCA_res)=="quanti.sup")==1){
        quanti_sup_tibble_adjusted<- dplyr::bind_rows(
          tibble::as_tibble(t(peptide_covariate_adjusted_data_PCA_res$quanti.sup$coord)) %>%
            mutate(dimensions = rownames(t(peptide_covariate_adjusted_data_PCA_res$quanti.sup$coord)),
                   parameter = "coordinates"),
          tibble::as_tibble(t(peptide_covariate_adjusted_data_PCA_res$quanti.sup$cor)) %>%
            mutate(dimensions = rownames(t(peptide_covariate_adjusted_data_PCA_res$quanti.sup$cor)),
                   parameter = "correlation_between_variables_and_axes"),
          tibble::as_tibble(t(peptide_covariate_adjusted_data_PCA_res$quanti.sup$cos2)) %>%
            mutate(dimensions = rownames(t(peptide_covariate_adjusted_data_PCA_res$quanti.sup$cos2)),
                   parameter = "cos2")
        ) %>%
          mutate(fraction = "adjusted")
      }

      #if quali sup is present
      if(sum(names(peptide_covariate_adjusted_data_PCA_res)=="quali.sup")==1){
        quali_sup_tibble_adjusted<- dplyr::bind_rows(
          tibble::as_tibble(t(peptide_covariate_adjusted_data_PCA_res$quali.sup$coord)) %>%
            mutate(dimensions = rownames(t(peptide_covariate_adjusted_data_PCA_res$quali.sup$coord)),
                   parameter = "coordinates"),
          tibble::as_tibble(t(peptide_covariate_adjusted_data_PCA_res$quali.sup$cos2)) %>%
            mutate(dimensions = rownames(t(peptide_covariate_adjusted_data_PCA_res$quali.sup$cos2)),
                   parameter = "cos2")
        ) %>%
          mutate(fraction = "adjusted")

      }

      # write quanti and quali PCA output
      if(!is.null(numeric_covariates_names)){
      combine_quanti_PCA_res <- bind_rows(quanti_sup_tibble,
                                          quanti_sup_tibble_adjusted)%>%
        dplyr::mutate(dimensions = factor(.data$dimensions,levels = paste("Dim.",1:10,sep="")))

      write_csv(x = combine_quanti_PCA_res,
                file = paste0(out_folder,"/","05_processed_data/",
                       sample_length,
                       "_sample_analysis/PCA_analysis__peptide_level_before_covariate_adjustment__quantitative_variables.csv"))

      # plot cos2 of quali suppl. data in PCA
      quanti_sup_plot<- ggplot(data = combine_quanti_PCA_res %>%
                                dplyr::filter(.data$parameter=="cos2") %>%
                                tidyr::pivot_longer(colnames(combine_quanti_PCA_res)[1:c(ncol(combine_quanti_PCA_res)-3)],
                                             names_to = "variables",
                                             values_to = "variable_values"),
                              mapping = aes(x = .data$dimensions,
                                            y = .data$variable_values,
                                            fill = .data$fraction)
      )+
        geom_bar(stat = "identity", position = "dodge")+
        facet_wrap(~.data$variables)+
        theme_light(base_size = 18)+
        theme(axis.text.x = element_text(angle = 90,vjust = 0.5,hjust = 1),
              legend.position = "bottom")+
        labs(title = "square cosine of numerical variables",
             y = expression("importance ("~cos^2~")"))+
        scale_fill_brewer(palette = "Dark2")

      ggsave_pdf_png(plot = quanti_sup_plot,
                     filename = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/PCA_analysis__peptide_level__covariate_adjustment__numerical_variables_cos2"),
                     width = length(numeric_covariates_names)*5,
                     height = 5)

      }

      if(!is.null(factor_covariates_names)){
        combine_quali_PCA_res <- bind_rows(quali_sup_tibble,
                                           quali_sup_tibble_adjusted) %>%
          dplyr::mutate(dimensions = factor(.data$dimensions,levels = paste("Dim.",1:10,sep="")))
        write_csv(x = combine_quali_PCA_res,
                  file = paste0(out_folder,"/","05_processed_data/",
                                sample_length,
                                "_sample_analysis/PCA_analysis__peptide_level_before_covariate_adjustment__categorical_variables.csv"))

        # plot cos2 of quali suppl. data in PCA
        quali_sup_plot<- ggplot(data = combine_quali_PCA_res %>%
                 dplyr::filter(.data$parameter == "cos2") %>%
                  tidyr::pivot_longer(colnames(combine_quali_PCA_res)[1:c(ncol(combine_quali_PCA_res)-3)],
                              names_to = "variables",
                              values_to = "variable_values"),
               mapping = aes(x = .data$dimensions,
                             y = .data$variable_values,
                             fill = .data$fraction)
               )+
          geom_bar(stat = "identity", position = "dodge")+
          facet_wrap(~.data$variables)+
          theme_light(base_size = 18)+
          theme(axis.text.x = element_text(angle = 90,vjust = 0.5,hjust = 1),
                legend.position = "bottom")+
          labs(title = "square cosine of supplementary categorical variables",
               y = expression("importance ("~cos^2~")"))+
          scale_fill_brewer(palette = "Dark2")

        ggsave_pdf_png(plot = quali_sup_plot,
                       filename = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/PCA_analysis__peptide_level__covariate_adjustment__categorical_variables_cos2"),
                       width = c(length(factor_covariates_names)+1)*5, #Inf issue
                       height = 5)
      }



      #prepare data for ggpairs
      peptide_PCA_1_to_5dim <- as.data.frame(peptide_data_PCA_res$ind$coord)[,1:5]
      peptide_PCA_1_to_5dim$R.FileName <- rownames(peptide_PCA_1_to_5dim)
      peptide_PCA_1_to_5dim <- left_join(tibble::as_tibble(peptide_PCA_1_to_5dim),
                                         habil,
                                         by="R.FileName") %>%
        dplyr::select(-.data$R.FileName)

      covariate_adjusted_peptide_PCA_1_to_5dim <- as.data.frame(peptide_covariate_adjusted_data_PCA_res$ind$coord)[,1:5]
      covariate_adjusted_peptide_PCA_1_to_5dim$R.FileName <- rownames(covariate_adjusted_peptide_PCA_1_to_5dim)
      covariate_adjusted_peptide_PCA_1_to_5dim <- dplyr::left_join(tibble::as_tibble(covariate_adjusted_peptide_PCA_1_to_5dim),
                                                                    habil,
                                                                    by="R.FileName") %>%
        dplyr::select(-.data$R.FileName)

      #setup condition colors

      if(sum(colnames(habil) %in% c("R.Replicate","R.FileName_raw"))==2){
        conditions <- colnames(habil %>% dplyr::select(-.data$R.FileName,
                                                       -.data$R.FileName_raw,
                                                       -.data$R.Replicate)
        )
      }else{
        conditions <- colnames(habil %>%
                                 dplyr::select(-.data$R.FileName)
        )
      }


      message_function(text = "plotting PCAs ... this might take a while",color = "blue",log_file_name = log_file_name)

      # plot PCA of covariate adjutsed peptide data ----
      for(i in 1:length(conditions)){

        #setup colors
        condition_elements_length<-length(unique(unlist(peptide_PCA_1_to_5dim[,conditions[i]])))
        if(condition_elements_length>length(general.colors)){
          condition_colors<-general.colors.gradient(condition_elements_length)
        }else{
          condition_colors<-general.colors[1:condition_elements_length]
        }
        names(condition_colors) <- unique(unlist(peptide_PCA_1_to_5dim[,conditions[i]]))


        #get habil_classes
        habil_classes<- habil %>%
          dplyr::summarise_all(class) %>%
          tidyr::pivot_longer(everything(),names_to = "variable", values_to = "class")

        #switch from factorial to numerical color gradient
        if(unlist(habil_classes %>%
                  dplyr::filter(.data$variable==conditions[i]) %>%
                  dplyr::select(.data$class)) != "numeric"){

          #peptide ggpairs plot 1-5 dim.
          ggplotPCA_peptide_PCA_1_to_5dim <- ggpairs(data = peptide_PCA_1_to_5dim,
                                                     columns = 1:5,
                                                     legend = c(1,1), #legend form sencond row and first column
                                                     title = paste(conditions[i]," - ","PCA 1st to 5th dim. (before covariate adj. peptide level)",sep=""),
                                                     mapping = aes_string(color=conditions[i],fill=conditions[i]),
                                                     upper  = list(continuous = "blank"),
                                                     lower = list(continuous = function(data, mapping, ...) {
                                                       ggally_points(data = data, mapping = mapping, alpha = .8,size=4) +
                                                         scale_colour_manual(values = condition_colors)+
                                                         geom_vline(xintercept = 0,linetype="dotted")+
                                                         geom_hline(yintercept = 0,linetype="dotted")
                                                     }
                                                     ),
                                                     diag = list(continuous = function(data, mapping, ...) {
                                                       ggplot(data = data, mapping = mapping)+geom_density(alpha = .4) +
                                                         scale_colour_manual(values = condition_colors) +
                                                         scale_fill_manual(values = condition_colors)
                                                     }
                                                     )
          )+
            theme_bw(base_size = 18)+
            theme(legend.position = "right")

          ggplotPCA_adj_peptide_PCA_1_to_5dim <- ggpairs(data = covariate_adjusted_peptide_PCA_1_to_5dim,
                                                         columns = 1:5,
                                                         legend = c(1,1), #legend form sencond row and first column
                                                         title = paste(conditions[i]," - ","PCA 1st to 5th dim. (covariate adj. peptide level)",sep=""),
                                                         mapping = aes_string(color=conditions[i],fill=conditions[i]),
                                                         upper  = list(continuous = "blank"),
                                                         lower = list(continuous = function(data, mapping, ...) {
                                                           ggally_points(data = data, mapping = mapping, alpha = .8,size=4) +
                                                             scale_colour_manual(values = condition_colors)+
                                                             geom_vline(xintercept = 0,linetype="dotted")+
                                                             geom_hline(yintercept = 0,linetype="dotted")
                                                         }
                                                         ),
                                                         diag = list(continuous = function(data, mapping, ...) {
                                                           ggplot(data = data, mapping = mapping)+geom_density(alpha = .4) +
                                                             scale_colour_manual(values = condition_colors) +
                                                             scale_fill_manual(values = condition_colors)
                                                         }
                                                         )
          )+
            theme_bw(base_size = 18)+
            theme(legend.position = "right")

          ggsave_pdf_png(plot = ggplotPCA_peptide_PCA_1_to_5dim,
                         filename = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/PCA_plot_1st_to_5th_dimension__before_covariate_ADJUSTED_peptide_level__",conditions[i]),
                         width = 20,
                         height = 15)
          ggsave_pdf_png(plot = ggplotPCA_adj_peptide_PCA_1_to_5dim,
                         filename = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/PCA_plot_1st_to_5th_dimension__covariate_ADJUSTED_peptide_level__",conditions[i]),
                         width = 20,
                         height = 15)



        }else{
          #peptide ggpairs plot 1-5 dim.

          # Define a custom function for the lower plot
          lowerFn <- function(data, mapping, ...) {
            p <- ggplot(data = data, mapping = mapping) +
              geom_point(aes(color = UQ(as.name(conditions[i]))), alpha = .8,size=4) +
              scale_color_distiller(palette = "Spectral")+
              geom_vline(xintercept = 0,linetype="dotted")+
              geom_hline(yintercept = 0,linetype="dotted")
            p
          }

          ggplotPCA_peptide_PCA_1_to_5dim <- ggpairs(
            data = peptide_PCA_1_to_5dim,
            columns = 1:5,
            legend = c(2,1), #legend form sencond row and first column
            title = paste(conditions[i]," - ","PCA 1st to 5th dim. (peptide level)",sep=""),
            lower = list(continuous = GGally::wrap(lowerFn)),
            upper  = list(continuous = "blank")
          )+
            theme_bw(base_size = 18)+
            theme(legend.position = "right")

          ggplotPCA_adj_peptide_PCA_1_to_5dim <- ggpairs(
            data = covariate_adjusted_peptide_PCA_1_to_5dim,
            columns = 1:5,
            legend = c(2,1), #legend form sencond row and first column
            title = paste(conditions[i]," - ","PCA 1st to 5th dim. (covariate adj. peptide level)",sep=""),
            lower = list(continuous = GGally::wrap(lowerFn)),
            upper  = list(continuous = "blank")
          )+
            theme_bw(base_size = 18)+
            theme(legend.position = "right")


          ggsave_pdf_png(plot = ggplotPCA_peptide_PCA_1_to_5dim,
                         filename = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/PCA_plot_1st_to_5th_dimension__before_covariate_ADJUSTED_peptide_level__",conditions[i]),
                         width = 20,
                         height = 15)
          ggsave_pdf_png(plot = ggplotPCA_adj_peptide_PCA_1_to_5dim,
                         filename = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/PCA_plot_1st_to_5th_dimension__covariate_ADJUSTED_peptide_level__",conditions[i]),
                         width = 20,
                         height = 15)


        }
      } # peptide_intensity_covariate_adjusted: PCA plotting end ----



      # parameter <- "CRP"
      # protein_lookup = "P02741"
      #
      # ggplot(peptide_intensity_covariate_adjusted %>%
      #              filter(PG.ProteinGroups==protein_lookup),aes(UQ(as.name(parameter)),log10_peptide_intensity, color = R.Condition))+
      # geom_point()+
      # stat_smooth(data = peptide_intensity_covariate_adjusted%>%
      #               filter(PG.ProteinGroups==protein_lookup), mapping = aes(UQ(as.name(parameter)),log10_peptide_intensity),
      #             method = "loess",color = "black",fill = "grey")+
      # stat_smooth(data = peptide_intensity_covariate_adjusted%>%
      #               filter(PG.ProteinGroups==protein_lookup), mapping = aes(UQ(as.name(parameter)),log10_peptide_intensity),
      #             method = "lm",color = "darkgreen",fill = "seagreen")+
      # facet_wrap(~EG.ModifiedPeptide, scales = "free")+
      # labs(title = "only normalized")+
      # scale_x_log10()+
      # scale_color_brewer(palette = "Set1")+
      # theme(legend.position = "bottom")+
      # ggplot(peptide_intensity_covariate_adjusted%>%
      #          filter(PG.ProteinGroups==protein_lookup),aes(UQ(as.name(parameter)),log10_adj_peptide_intensity, color = R.Condition))+
      # geom_point()+
      # stat_smooth(data = peptide_intensity_covariate_adjusted%>%
      #               filter(PG.ProteinGroups==protein_lookup), mapping = aes(UQ(as.name(parameter)),log10_adj_peptide_intensity),
      #             method = "loess",color = "black",fill = "grey")+
      # stat_smooth(data = peptide_intensity_covariate_adjusted%>%
      #               filter(PG.ProteinGroups==protein_lookup), mapping = aes(UQ(as.name(parameter)),log10_adj_peptide_intensity),
      #             method = "lm",color = "darkgreen",fill = "seagreen")+
      # facet_wrap(~EG.ModifiedPeptide, scales = "free")+
      # labs(title = "adjusted")+
      # scale_x_log10()+
      # theme(legend.position = "bottom")+
      # scale_color_brewer(palette = "Set1")
      #
      message_function(text = "End of covariate adjusting process ...",color = "blue",log_file_name = log_file_name)

      # overwrite peptide_intensity
      peptide_intensity <- peptide_intensity_covariate_adjusted %>%
        dplyr::select(-.data$peptide_intensity,
                      -.data$log10_adj_peptide_intensity,
                      -.data$log10_peptide_intensity) %>%
        dplyr::rename(peptide_intensity = .data$peptide_intensity_covariate_adjusted)

    }else{

      peptide_intensity_covariate_adjusted <- NULL

    } # END: adjusting peptide intensities for covariates ====






# start protein intensity calculation -------------------------------------

    message_function(text = "protein intensity calculation ...",color = "blue",log_file_name = log_file_name)


    # iBAQ extraction from SN report ====
    message_function(text = "extracting iBAQ intensities from Spectronaut report ...",color = "blue",log_file_name = log_file_name)

    # iBAQ extraction from report and  cleaning by mean over iBAQ values in PG
    data_iBAQ<- data %>%
      dplyr::distinct(.data$R.FileName,
                      .data$R.Condition,
                      .data$R.Replicate,
                      .data$PG.ProteinGroups,
                      .data$PG.IBAQ) %>%
      dplyr::group_by(.data$R.FileName,
               .data$R.Condition,
               .data$R.Replicate,
               .data$PG.ProteinGroups) %>%
      # workaround for protein grouping iBAQ; e.g. O34742;P39775 >> iBAQ: 1086.8;1222.6
      # workaround is to build the mean for the estimation
      dplyr::summarize(iBAQ_intensities = mean(as.numeric(unlist(strsplit(.data$PG.IBAQ, ";|,"))), na.rm = T),
                PG.IBAQ_raw = .data$PG.IBAQ) %>%
      ungroup()
      # end workaround iBAQ issue

    message_function(text = "calc. mean, SD, CV of iBAQ intensities ...",color = "blue",log_file_name = log_file_name)

    # calc. mean, sd and CV of iBAQ intensities
    data_iBAQ_summary <- data_iBAQ %>%
      dplyr::group_by(.data$R.Condition,
                      .data$PG.ProteinGroups) %>%
      dplyr::summarize(mean_iBAQ_intensities = mean(.data$iBAQ_intensities, na.rm = T),
                       SD_iBAQ_intensities = sd(.data$iBAQ_intensities, na.rm = T),
                       CV_iBAQ_intensities = sd(.data$iBAQ_intensities, na.rm = T)/mean(.data$iBAQ_intensities, na.rm = T)
                ) %>%
      ungroup()

    # bin splitting of iBAQ values
    data_iBAQ_summary <- data_iBAQ_summary %>%
                          dplyr::group_by(.data$R.Condition) %>%
                          dplyr::mutate(iBAQ_quantiles = paste0("Q",ntile(.data$mean_iBAQ_intensities,n = 10)))

    message_function(text = "... save iBAQ data ...",color = "blue",log_file_name = log_file_name)

    #write iBAQ output
    write_csv(x = data_iBAQ,
              file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/iBAQ_protein_intensity_data_extracted_from_Spectronaut.csv"))
    write_csv(x = data_iBAQ_summary,
              file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/iBAQ_protein_intensity_data_extracted_from_Spectronaut_summary.csv"))


    # iBAQ covariate adjustment from SN report ====

    if(nchar(covariate_adjusting_formula)!=0 & covariate_adjusting_meta_data_file!=""){

      message_function(text = "covariate adjustment of iBAQ intensities from Spectronaut report ...",color = "green",log_file_name = log_file_name)
      # add covariate table and perform log10 transformation of peptide intensity data
      iBAQ_intensity_covariate<- left_join(data_iBAQ,
                                              covaribale_meta_data[,colnames(covaribale_meta_data)%nin%c("R.FileName", "R.Condition", "R.Replicate")], #remove redundant colnames
                                              by = c("R.FileName_raw" = "R.FileName")) %>%
        #perform log10 transformation of peptide intensity
        dplyr::mutate(log10_iBAQ_intensities = log10(.data$iBAQ_intensities))

      #generate model for fit
      covariate_model <- function(df) {
        stats::lm(as.formula(
          stringr::str_replace_all(string = covariate_adjusting_formula,
                                  pattern = "log10_peptide_intensity",
                                  replacement = "log10_iBAQ_intensities")
          ),
          data = df)
      }

      #adjusting peptide intensity data for covariates using user formula
      iBAQ_intensity_covariate_model<- iBAQ_intensity_covariate %>%
        dplyr::group_by(.data$PG.ProteinGroups) %>%
        tidyr::nest() %>%
        dplyr::mutate(model = purrr::map(.x = .data$data,
                                         .f = covariate_model)) %>%
        dplyr::mutate(residuals = purrr::map2(.x = .data$data,
                                              .y = .data$model,
                                              .f = modelr::add_residuals))

      # write covaribale adjusted peptide model file
      message_function(text = "write PG iBAQ level covariate model file ...",color = "blue",log_file_name = log_file_name)
      write_rds(x = iBAQ_intensity_covariate_model,
                file = paste0(out_folder,"/","05_processed_data/",
                              sample_length,
                              "_sample_analysis/iBAQ_intensities_final_covariate_MODEL.RDS")
      )

      # get residuals and add mean of peptide to get the corrected peptide intensity space
      iBAQ_intensity_covariate_model_adjusted <- iBAQ_intensity_covariate_model %>%
        dplyr::select(-.data$model,
                      -.data$data) %>%
        unnest(cols = c("residuals")) %>%
        dplyr::group_by(.data$PG.ProteinGroups) %>%
        dplyr::mutate(log10_adj_iBAQ_intensities = .data$resid + mean(.data$log10_iBAQ_intensities,na.rm = T)) %>%
        dplyr::mutate(iBAQ_intensities_covariate_adjusted = 10^.data$log10_adj_iBAQ_intensities) %>%
        ungroup()




      # broom tidy extract of model data using glance
      message_function(text = "extract iBAQ level covariate adjusting model summary ...",color = "blue",log_file_name = log_file_name)

      iBAQ_intensity_covariate_adjusted_model_summary <- iBAQ_intensity_covariate_model %>%
        dplyr::select(-.data$data,
                      -.data$residuals) %>%
        dplyr::group_by(.data$PG.ProteinGroups) %>%
        dplyr::mutate(glance = purrr::map(.x = .data$model,
                                          .f = broom::glance)) %>%
        tidyr::unnest(glance) %>%
        dplyr::select(-.data$model)

      #write model summary file
      message_function(text = "write iBAQ level covariate model file paramter file ...",color = "blue",log_file_name = log_file_name)

      write_csv(x = iBAQ_intensity_covariate_adjusted_model_summary,
                file = paste0(out_folder,"/","05_processed_data/",
                              sample_length,
                              "_sample_analysis/peptide_intensities_final_covariate_MODEL_SUMMARY.csv")
      )


      # sort table
      iBAQ_intensity_covariate_model_adjusted <- iBAQ_intensity_covariate_model_adjusted %>%
        dplyr::select(.data$R.FileName,
                      .data$R.Replicate,
                      .data$R.Condition,
                      .data$PG.ProteinGroups,
                      .data$iBAQ_intensities,
                      .data$iBAQ_intensities_covariate_adjusted,
                      .data$log10_iBAQ_intensities,
                      .data$log10_adj_iBAQ_intensities,
                      everything())

      # write adjusted peptide intensity out
      write_csv(x = iBAQ_intensity_covariate_model_adjusted,
                file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/iBAQ_intensities_final_covariate_unadjusted__and__adjusted.csv"))


    }



    # Hi3 calculation ====
    if(parameter$protein_intensity_estimation=="Hi3"){

      message_function(text = "perform Hi3 protein intensity calculation ...",color = "blue",log_file_name = log_file_name)

      #filter for minimum 2 peptides
      message_function(text = "... filter for at least 2 peptides per Protein group ...",color = "blue",log_file_name = log_file_name)

      peptide_intensity_filtered_2pep <- peptide_intensity %>%
        dplyr::group_by(.data$PG.ProteinGroups) %>%
        dplyr::filter(n_distinct(.data$PEP.StrippedSequence)>=2) %>%
        ungroup()


      #do median intensity per protein and peptide over condition to estimate the most intense peptides over all conditions per protein // filter for Top 1-3
      message_function(text = "... determining highest peptides over conditions using the median ...",color = "blue",log_file_name = log_file_name)

      peptide_intensity_filtered_2pep_ranked <- peptide_intensity_filtered_2pep %>%
        dplyr::group_by(.data$PG.ProteinGroups,
                        .data$PEP.StrippedSequence) %>%
        dplyr::summarise(median_peptide_intensity = median(.data$peptide_intensity,na.rm=T)) %>%
        dplyr::top_n(.data$median_peptide_intensity,
                     n = 3)


      #filter peptide intensity list for the top-3 median ranked peptides
      peptide_intensity_filtered_2pep_hi3 <- peptide_intensity_filtered_2pep %>%
        dplyr::filter(.data$PEP.StrippedSequence %in% peptide_intensity_filtered_2pep_ranked$PEP.StrippedSequence)

      write_csv(x = peptide_intensity_filtered_2pep_hi3,
                  file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/peptide_intensities_used_for_hi3_protein_intensities.csv"))

      message_function(text = "... calculating Hi3 intensity ...",color = "blue",log_file_name = log_file_name)

      protein_data_Hi3 <- peptide_intensity_filtered_2pep_hi3 %>%
        dplyr::group_by(.data$R.FileName,
                        .data$R.Condition,
                        .data$R.Replicate,
                        .data$PG.ProteinGroups) %>%
        dplyr::summarise(protein_intensity = mean(.data$peptide_intensity,na.rm=T)) %>%
        ungroup()

      # add rank data // 1st rank = highest intensity
      protein_data_Hi3 <- protein_data_Hi3 %>%
        dplyr::group_by(.data$R.FileName,
                 .data$R.Condition,
                 .data$R.Replicate) %>%
        dplyr::mutate(intensity_rank = dense_rank(desc(.data$protein_intensity))) %>%
        ungroup()

      #median normalization of Hi3 data
      message_function(text = "... do median normalization of Hi3 data ...",color = "blue",log_file_name = log_file_name)

      #global Hi3 median
      Hi3med<-median(protein_data_Hi3$protein_intensity, na.rm = T)

      #calculate Hi3 normalization factor
      protein_data_Hi3_norm_factor <- protein_data_Hi3 %>%
        dplyr::group_by(.data$R.FileName) %>%
        dplyr::summarise(protein_intensity_post_calculation_normalization_factor = Hi3med/median(.data$protein_intensity,na.rm=T)) %>%
        ungroup()

      #Hi3 normalization
      protein_data_Hi3 <- protein_data_Hi3 %>%
        dplyr::group_by(.data$R.FileName) %>%
        dplyr::mutate(raw_protein_intensity = .data$protein_intensity) %>%
        dplyr::mutate(protein_intensity = .data$protein_intensity*(Hi3med/median(.data$protein_intensity,na.rm=T))) %>%
        ungroup()



      #do Hi3 normalization boxplot plot ====
      Norm_plot_Hi3 <- protein_data_Hi3 %>%
        dplyr::select(.data$R.FileName,
                      .data$PG.ProteinGroups,
                      .data$raw_protein_intensity,
                      .data$protein_intensity) %>%
        pivot_longer(cols = c("raw_protein_intensity","protein_intensity"),
                     names_to = "data_fraction",
                     values_to = "intensity") %>%
        dplyr::mutate(data_fraction = fct_relevel(.data$data_fraction, "raw_protein_intensity")) %>%
        ggplot(mapping = aes(x = .data$R.FileName,
                             y = .data$intensity))+
        geom_boxplot(outlier.colour = NA)+
        scale_y_log10()+
        facet_wrap(~.data$data_fraction,
                   labeller = labeller(data_fraction = c("raw_protein_intensity" = "raw Hi3 data",
                                                         "protein_intensity" = "med. norm. Hi3 data"))
                   )+
        coord_flip()+
        geom_hline(yintercept = median(protein_data_Hi3$protein_intensity,na.rm = T), linetype = "dashed")+
        theme_light(base_size = 18)+
        labs(title = "Hi3 intensities",
             subtitle = "raw data vs. med. norm. data",
             x = "",
             y = "Hi3 intensity")


      message_function(text = "... save Hi3 boxplot ...",color = "blue",log_file_name = log_file_name)

      ggsave_pdf_png(filename = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/Hi3_protein_intensity_boxplot"),
                     plot = Norm_plot_Hi3,
                     limitsize = F,
                     height = if((0.2*sample_length)<15){15}else{0.2*sample_length},
                     width = 20)


      message_function(text = "... save Hi3 data ...",color = "blue",log_file_name = log_file_name)

      #write Hi3 output
      write_csv(x = protein_data_Hi3,
                file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/Hi3_protein_intensity_data.csv"))

      #write Hi3 output wide
      protein_data_Hi3 %>%
        dplyr::select(.data$PG.ProteinGroups,
                      .data$R.FileName,
                      .data$protein_intensity) %>%
        pivot_wider(names_from = .data$R.FileName,
                    values_from = .data$protein_intensity) %>%
        write_csv(file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/Hi3_protein_intensity_data_wideFormat.csv"))

      #write Hi3 rank output wide
      protein_data_Hi3 %>%
        dplyr::select(.data$PG.ProteinGroups,
                      .data$R.FileName,
                      .data$intensity_rank) %>%
        pivot_wider(names_from = .data$R.FileName,
                    values_from = .data$intensity_rank) %>%
        write_csv(file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/Hi3_protein_intensity_rank_data_wideFormat.csv"))

      #write Hi3 normalization factor output
      write_csv(x = protein_data_Hi3_norm_factor,
                file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/Hi3_protein_intensity_data_normalization_factor.csv"))

      # final data protein data
      protein_data <- protein_data_Hi3
      protein_data_normalization_factor <- protein_data_Hi3_norm_factor


    }

    #maxLFQ calculation ====
    if(parameter$protein_intensity_estimation=="MaxLFQ"){
      message_function(text = "perform maxLFQ protein intensity calculation ... (this will take some time)",color = "blue",log_file_name = log_file_name)

      # perform exidized peptide filtering if selected
      if(parameter$filter_oxidized_peptides==T){
        maxLFQ_data_input <- peptide_intensity %>%
          dplyr::filter(!grepl(pattern = "Oxidation",.data$EG.ModifiedPeptide))
      }else{
        maxLFQ_data_input <- peptide_intensity
      }

      # preprocess peptide data
      message_function(text = "... preprocessing data for MaxLFQ estimation ...",color = "blue",log_file_name = log_file_name)

      #MaxLFQ estimation on peptide level
      maxLFQ_preprocess_spectronaut_out<- preprocess(quant_table = as.data.frame(maxLFQ_data_input),
                                                       primary_id = "PG.ProteinGroups", # Unique values in this column form the list of proteins to be quantified.
                                                       secondary_id = c("EG.ModifiedPeptide", "PEP.StrippedSequence"),# A concatenation of these columns determines the fragment ions used for quantification.
                                                       sample_id = "R.FileName", #Unique values in this column form the list of samples.
                                                       intensity_col = "peptide_intensity", # The column for intensities.
                                                       median_normalization = F, #A logical value. The default TRUE value is to perform median normalization.
                                                       log2_intensity_cutoff = -600, #Entries lower than this value in log2 space are ignored. Plot a histogram of all intensities to set this parameter.
                                                       pdf_out = NULL, # for QC
                                                       pdf_width = 12,
                                                       pdf_height = 8)




      # generate a protein list
      message_function(text = "... generate protein list for MaxLFQ estimation ...",color = "blue",log_file_name = log_file_name)

      maxLFQ_protein_list <- create_protein_list(maxLFQ_preprocess_spectronaut_out)

      # calculate maxLFQ results
      message_function(text = "... calculation of MaxLFQ ...",color = "blue",log_file_name = log_file_name)

      maxLFQ_result <- create_protein_table(maxLFQ_protein_list)

      # generate wide output
      message_function(text = "... generate outputs for MaxLFQ estimation ...",color = "blue",log_file_name = log_file_name)

      maxLFQ_results_out <- tibble::as_tibble(cbind(PG.ProteinGroups = rownames(maxLFQ_result$estimate),
                                            2^maxLFQ_result$estimate))# delog from log2 space of maxLFQ protein int. estimation

      # generate tidy output
      maxLFQ_results_out_tidy <- maxLFQ_results_out %>%
        pivot_longer(cols = colnames(maxLFQ_results_out)[-1],
                     names_to = "R.FileName",
                     values_to = "protein_intensity")

      # convert to maxLFQ numeric column
      maxLFQ_results_out_tidy <- maxLFQ_results_out_tidy %>%
        dplyr::mutate(protein_intensity = as.numeric(.data$protein_intensity))

      # add condition replicate column to tidy
      maxLFQ_results_out_tidy <- left_join(maxLFQ_results_out_tidy,
                                    data %>%
                                      dplyr::distinct(.data$R.FileName,
                                                      .data$R.Condition,
                                                      .data$R.Replicate),
                                    by = "R.FileName")

      # add rank data // 1st rank = highest intensity
      maxLFQ_results_out_tidy <- maxLFQ_results_out_tidy %>%
        dplyr::group_by(.data$R.FileName,
                        .data$R.Condition,
                        .data$R.Replicate) %>%
        dplyr::mutate(intensity_rank = dense_rank(desc(.data$protein_intensity))) %>%
        ungroup()

      if(skipping_MaxLFQ_median_norm==FALSE){
        #median normalization of MaxLFQ data
        message_function(text = "... do median normalization of MaxLFQ data ...",color = "blue",log_file_name = log_file_name)

        #global MaxLFQ median
        maxLFQmed <- median(maxLFQ_results_out_tidy$protein_intensity  , na.rm = T)

        #calculate MaxLFQ normalization factor
        maxLFQ_results_out_tidy_norm_factor <- maxLFQ_results_out_tidy %>%
          dplyr::group_by(.data$R.FileName) %>%
          dplyr::summarise(maxLFQ_post_calculation_normalization_factor = maxLFQmed/median(.data$protein_intensity,na.rm=T)) %>%
          ungroup()

        #MaxLFQ normalization
        maxLFQ_results_out_tidy <- maxLFQ_results_out_tidy %>%
          dplyr::group_by(.data$R.FileName) %>%
          dplyr::mutate(raw_protein_intensity = .data$protein_intensity) %>%
          dplyr::mutate(protein_intensity = .data$protein_intensity*(maxLFQmed/median(.data$protein_intensity,na.rm=T))) %>%
          ungroup()


        #do MaxLFQ normalization boxplot plot ====
        Norm_plot_MaxLFQ <- maxLFQ_results_out_tidy %>%
          dplyr::select(.data$R.FileName,
                        .data$PG.ProteinGroups,
                        .data$raw_protein_intensity,
                        .data$protein_intensity) %>%
          pivot_longer(cols = c("raw_protein_intensity","protein_intensity"),
                       names_to = "data_fraction",
                       values_to = "intensity") %>%
          dplyr::mutate(data_fraction = fct_relevel(.data$data_fraction, "raw_protein_intensity")) %>%
          ggplot(mapping = aes(x = .data$R.FileName,
                               y = .data$intensity))+
          geom_half_violin(fill = "grey",side = "r", color = NA,trim = F,scale = "width")+
          geom_half_boxplot(outlier.colour = NA,side = "l", fill = "white",errorbar.draw = F)+
          scale_y_log10()+
          annotation_logticks(sides = "b")+
          facet_wrap(~.data$data_fraction, labeller = labeller(data_fraction = c("raw_protein_intensity" = "raw MaxLFQ data",
                                                                                 "protein_intensity" = "med. norm. MaxLFQ data")))+
          coord_flip()+
          geom_hline(yintercept = median(maxLFQ_results_out_tidy$protein_intensity,na.rm = T), linetype = "dashed")+
          theme_light(base_size = 18)+
          labs(title = "MaxLFQ intensities",
               subtitle = "raw data vs. med. norm. data",
               x = "",
               y = "MaxLFQ intensity")


        message_function(text = "... save MaxLFQ boxplot ...",color = "blue",log_file_name = log_file_name)

        ggsave_pdf_png(filename = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/MaxLFQ_protein_intensity_boxplot"),
                       plot = Norm_plot_MaxLFQ,
                       limitsize = F,
                       height = if((0.2*sample_length)<15){15}else{0.2*sample_length},
                       width = 20)

      }else{
        message_function(text = "... skipping median normalization of maxLFQ data ...",color = "blue",log_file_name = log_file_name)
        #MaxLFQ normalization
        maxLFQ_results_out_tidy <- maxLFQ_results_out_tidy %>%
          dplyr::mutate(raw_protein_intensity = .data$protein_intensity)

        #MaxLFQ normalization factor
        maxLFQ_results_out_tidy_norm_factor <- maxLFQ_results_out_tidy %>%
          dplyr::distinct(.data$R.FileName) %>%
          dplyr::mutate(maxLFQ_post_calculation_normalization_factor = 1)

        raw_plot_MaxLFQ <- ggplot(maxLFQ_results_out_tidy,mapping = aes(x = .data$R.FileName,
                             y = .data$protein_intensity))+
          geom_half_violin(fill = "grey",side = "r", color = NA,trim = F,scale = "width")+
          geom_half_boxplot(outlier.colour = NA,side = "l", fill = "white",errorbar.draw = F)+
          scale_y_log10()+
          annotation_logticks(sides = "b")+
          coord_flip()+
          geom_hline(yintercept = median(maxLFQ_results_out_tidy$protein_intensity,na.rm = T), linetype = "dashed")+
          theme_light(base_size = 18)+
          labs(title = "MaxLFQ intensities",
               subtitle = "",
               x = "",
               y = "MaxLFQ intensity")


        message_function(text = "... save MaxLFQ boxplot ...",color = "blue",log_file_name = log_file_name)

        ggsave_pdf_png(filename = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/MaxLFQ_protein_intensity_boxplot"),
                       plot = raw_plot_MaxLFQ,
                       limitsize = F,
                       height = if((0.2*sample_length)<15){15}else{0.2*sample_length},
                       width = 10)


      }



      message_function(text = "... save MaxLFQ data ...",color = "blue",log_file_name = log_file_name)

      # write maxLFQ wide-results
      maxLFQ_results_out_tidy %>%
        dplyr::select(.data$PG.ProteinGroups,
                      .data$R.FileName,
                      .data$protein_intensity) %>%
        pivot_wider(names_from = .data$R.FileName,
                    values_from = .data$protein_intensity) %>%
        write_csv(file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/maxLFQ_protein_intensity_data_wideFormat.csv"))

      # write maxLFQ tidy-results
      write_csv(x = maxLFQ_results_out_tidy,
                file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/maxLFQ_protein_intensity_data.csv"))


      # write maxLFQ normalization factor
      write_csv(x = maxLFQ_results_out_tidy_norm_factor,
                file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/maxLFQ_protein_intensity_data_normalization_factor.csv"))

      #write maxLFQ rank output wide
      maxLFQ_results_out_tidy %>%
        dplyr::select(.data$PG.ProteinGroups,
                      .data$R.FileName,
                      .data$intensity_rank) %>%
        pivot_wider(names_from = .data$R.FileName,
                    values_from = .data$intensity_rank) %>%
        write_csv(paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/maxLFQ_protein_intensity_rank_data_wideFormat.csv"))

      # final data protein data
      protein_data <- maxLFQ_results_out_tidy
      protein_data_normalization_factor <- maxLFQ_results_out_tidy_norm_factor
    }


# compare protein intensity (maxLFQ /Hi3 ) to iBAQ intensity --------
    message_function(text = "... compare protein intensities and iBAQ protein intensities ...",color = "blue",log_file_name = log_file_name)

    protein_int_iBAQ_comp_table<- left_join(protein_data %>%
                                              dplyr::select(.data$PG.ProteinGroups,
                                                            .data$R.FileName,
                                                            .data$R.Condition,
                                                            .data$R.Replicate,
                                                            .data$protein_intensity),
                                            data_iBAQ %>%
                                              dplyr::select(.data$PG.ProteinGroups,
                                                            .data$R.FileName,
                                                            .data$R.Condition,
                                                            .data$R.Replicate,
                                                            .data$iBAQ_intensities) %>%
                                              dplyr::mutate(iBAQ_intensities = ifelse(test = .data$iBAQ_intensities==0,
                                                                               yes = NA,
                                                                               no = .data$iBAQ_intensities)),
                                                     by = c("PG.ProteinGroups",
                                                            "R.FileName",
                                                            "R.Condition",
                                                            "R.Replicate")
                                            )#set 0 to NA


    protein_int_iBAQ_comp_table_counts <- protein_int_iBAQ_comp_table %>%
      dplyr::group_by(.data$R.FileName,
                      .data$R.Condition,
                      .data$R.Replicate) %>%
      dplyr::summarise(count_protein_intensity = n_distinct(.data$PG.ProteinGroups[!is.na(.data$protein_intensity)]),
                       count_iBAQ_intensities = n_distinct(.data$PG.ProteinGroups[!is.na(.data$iBAQ_intensities)])) %>%
      ungroup()

    #iBAQ_protein_int_p1
    iBAQ_protein_int_p1 <- ggplot(data = protein_int_iBAQ_comp_table,
                                  mapping = aes(x = .data$R.FileName,
                                                y = log2(.data$protein_intensity/.data$iBAQ_intensities)))+
      geom_half_violin(fill = "grey",side = "l", color = NA,trim = F,scale = "width")+
      geom_half_boxplot(outlier.colour = NA,side = "r", fill = "white",errorbar.draw = F)+
      labs(y = expression(log[2]~"ratios of protein int. / iBAQ protein int."),
           x = "", title = "protein-wise ratios between protein intensity (e.g. maxLFQ) and iBAQ")+
      theme_light(base_size = 16)+
      theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust = 0.5))

    #iBAQ_protein_int_p2
    iBAQ_protein_int_p2 <- ggplot(data = protein_int_iBAQ_comp_table_counts %>%
             pivot_longer(c("count_protein_intensity","count_iBAQ_intensities"),
                          names_to = "fraction",
                          values_to = "counts"),
           mapping = aes(x = .data$R.FileName,
                         y = .data$counts,
                         fill = .data$fraction))+
      geom_bar(stat = "identity", position = "dodge")+
      scale_fill_brewer(palette = "Dark2")+
      labs(y = "valid value count",
           x = "",
           caption = "iBAQ = 0 where replaced by NA values",
           title = "valid value count protein intensity (e.g. maxLFQ) and iBAQ")+
      theme_light(base_size = 16)+
      theme(axis.text.x = element_text(angle = 90,hjust = 1,vjust = 0.5))

    ggsave_pdf_png(filename = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/protein_intensities_vs_iBAQ_intensities"),
                   plot = iBAQ_protein_int_p1/iBAQ_protein_int_p2,
                   limitsize = F,
                   height = 16,
                   width = if((0.2*sample_length)<15){15}else{0.2*sample_length}
    )


    # CV plot calculations ====
    message_function(text = "... CV plot calculation ...",color = "blue",log_file_name = log_file_name)



    # CV of protein data
    protein_data_CV_data <- protein_data %>%
      dplyr::group_by(.data$R.Condition,
                      .data$PG.ProteinGroups) %>%
      dplyr::summarise(mean_protein_intensity = mean(.data$protein_intensity,na.rm=T),
                CV_protein_intensity = sd(.data$protein_intensity,na.rm=T) / mean(.data$protein_intensity,na.rm=T))

    total_number_of_proteins <- length(unique(protein_data_CV_data$PG.ProteinGroups))
    max_protein_int <- quantile(protein_data_CV_data$mean_protein_intensity,probs = 0.999,na.rm = T)

    # CV of peptide data
    peptide_data_CV_data <- peptide_intensity %>%
      dplyr::group_by(.data$R.Condition,
                      .data$PG.ProteinGroups,
                      .data$EG.ModifiedPeptide) %>%
      dplyr::summarise(mean_peptide_intensity = mean(.data$peptide_intensity,na.rm=T),
                       CV_peptide_intensity = sd(.data$peptide_intensity,na.rm=T) / mean(.data$peptide_intensity,na.rm=T))

    total_number_of_peptides <- length(unique(peptide_intensity$EG.ModifiedPeptide))

    #generate label table below 10 adn 20% CV
    protein_data_CV_data_below_10percent <- protein_data_CV_data %>%
      dplyr::filter(.data$CV_protein_intensity<=0.1) %>%
      dplyr::summarise(percent = paste(round(n() / total_number_of_proteins*100,
                                      digits = 2),
                                      "%")
      )

    protein_data_CV_data_below_20percent <- protein_data_CV_data %>%
      dplyr::filter(.data$CV_protein_intensity <= 0.2) %>%
      dplyr::summarise(percent = paste(round(n() / total_number_of_proteins*100,
                                      digits = 2),
                                      "%")
      )

    #genrate CV plot
    # if all CV values = NA --> only 1 replicate per condition
    if(sum(is.na(protein_data_CV_data$CV_protein_intensity))==nrow(protein_data_CV_data)){
      CV_plot<- ggplot(data = protein_data_CV_data,
                       mapping = aes(x = .data$mean_protein_intensity,
                                     y = .data$CV_protein_intensity))+
        theme_light(base_size = 14)+
        scale_fill_distiller(palette = "Spectral")+
        facet_wrap(~ .data$R.Condition,ncol = 3)+
        scale_y_continuous(trans = "log10",breaks=c(0.001,0.01,0.05,0.1,0.2,0.5,1,2))+
        scale_x_log10()+
        annotation_logticks(sides = "b")+
        geom_hline(yintercept = 0.1)+
        geom_hline(yintercept = 0.2,linetype="dotted")+
        labs(title = "CV plot over conditions (based on protein intensity)",
             subtitle = "one replicate measurements - CV calc. not possible !!!",
             caption = "loess fit (span = 0.75) >> black line", x = "protein intensity", y = "CV")
    }else{
      CV_plot<- ggplot(data = protein_data_CV_data,
                       mapping = aes(x = .data$mean_protein_intensity,
                                     y = .data$CV_protein_intensity))+
        theme_light(base_size = 14)+
        geom_point(alpha=0.1,size=0.5,shape=19)+
        stat_density2d(mapping = aes(fill = after_stat(.data$level),
                                     alpha = after_stat(.data$level)),
                       linewidth=1,
                       bins=20,
                       geom="polygon")+
        scale_fill_distiller(palette = "Spectral")+
        stat_smooth(formula = y ~ x,
                    geom="line",
                    size=1.5,
                    method = "loess",
                    se=T,
                    color="black",
                    alpha=0.9)+
        facet_wrap(~ .data$R.Condition,ncol = 3)+
        scale_y_continuous(trans = "log10",breaks=c(0.001,0.01,0.05,0.1,0.2,0.5,1,2))+
        scale_x_log10()+
        annotation_logticks(sides = "b")+
        geom_hline(yintercept = 0.1)+
        geom_hline(yintercept = 0.2,linetype="dotted")+
        labs(title = "CV plot over conditions (based on protein intensity)",
             subtitle = "percentage below a CV of 0.1 or 0.2 is displayed",
             caption = "loess fit (span = 0.75) >> black line", x = "protein intensity", y = "CV")
    }




    #add labels below 10 adn 20% CV
    if(dim(protein_data_CV_data_below_10percent)[1]!=0){
      CV_plot <- CV_plot + geom_label(data = protein_data_CV_data_below_10percent,
                                      mapping = aes(x = max_protein_int,
                                                    y = 0.12,
                                                    label = .data$percent),
                                      colour = "hotpink",
                                      fontface = "bold",
                                      inherit.aes = F)


    }
    if(dim(protein_data_CV_data_below_20percent)[1]!=0){
      CV_plot <- CV_plot + geom_label(data = protein_data_CV_data_below_20percent,
                                      mapping = aes(x = max_protein_int,
                                                    y = 0.24,
                                                    label = .data$percent),
                                      colour = "hotpink",
                                      inherit.aes = F)
    }



# CV cumsum ---------------------------------------------------------------
    #render CV plot
    message_function(text = "... calc. cumulative frequency of CV ...",color = "blue",log_file_name = log_file_name)

    cv_seq <- c(seq(1,100,by = 1)/100,2)
    cumsum_CV <- c()
    for(i in 1:length(cv_seq)){
      statusprogressbar(run = i,max.run = length(cv_seq),width = 60L,info = "calculation ...")
        cumsum_CV <- dplyr::bind_rows(cumsum_CV,
                                      #peptide level
                                      peptide_data_CV_data %>%
                                        dplyr::filter(.data$CV_peptide_intensity <= cv_seq[i]) %>%
                                        dplyr::group_by(.data$R.Condition) %>%
                                        dplyr::summarise(`cumulative frequency` = n()) %>%
                                        dplyr::mutate(CV_cut = cv_seq[i],
                                                      level = "peptide level"),
                                      #protein level
                                      protein_data_CV_data %>%
                                        dplyr::filter(.data$CV_protein_intensity <= cv_seq[i]) %>%
                                        dplyr::group_by(.data$R.Condition) %>%
                                        dplyr::summarise(`cumulative frequency` = n()) %>%
                                        dplyr::mutate(CV_cut = cv_seq[i],
                                                      level = "protein level")


        )
            }
    #add proportion
    cumsum_CV <-  cumsum_CV %>%
      rowwise() %>%
      dplyr::mutate(`cumulative frequency proportion` = ifelse(test = .data$level=="protein level",
                                                        yes = .data$`cumulative frequency`/ total_number_of_proteins,
                                                        no = .data$`cumulative frequency`/ total_number_of_peptides)) %>%
      ungroup()


    # write out csv of CV cumsum
      write_csv(x = cumsum_CV %>%
                  dplyr::filter(.data$CV_cut == 0.2),
                file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/CV_20percent_cumulative_frequency.csv"))
      write_csv(x = cumsum_CV,
                file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/CV_cumulative_frequency.csv"))

    if(nrow(cumsum_CV)!=0){
      cumsum_CV_plot<- ggplot(data = cumsum_CV,mapping = aes(x = .data$CV_cut,
                                                             y = .data$`cumulative frequency proportion`,
                                                             color = .data$R.Condition))+
        geom_vline(xintercept = 0.1, linetype = "dashed")+
        geom_vline(xintercept = 0.2, linetype = "solid")+
        geom_line(size = 1.5,alpha = 0.8)+
        labs(title = "CV cumulative frequency plot",
             x = "coefficient of variation (CV)",
             y = "cumulative frequency",
             color = "condition",
             caption = "dashed line: CV = 0.1; solid line: CV = 0.2")+
        facet_wrap(~level, nrow = 1, scales = "free_y")+
        theme_light(base_size = 18)+
        scale_color_manual(values = condition_colors)+
        theme(legend.position = "bottom")+
        scale_y_continuous(labels = scales::percent)
    }else{

      cumsum_CV_plot<- plot_spacer()+
        plot_spacer()+
        plot_annotation(title = "CV cumulative frequency plot",
                        subtitle = "one replicate measurements - CV calc. not possible !!!")
    }



    #render CV plot
    message_function(text = "... render CV plot ...",color = "blue",log_file_name = log_file_name)

    ggsave_pdf_png(filename = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/CV_vs_intensity_plot"),
           plot = CV_plot,
           limitsize = F,
           width = 12,
           height = ifelse(test = round(length(unique(protein_data$R.Condition))/3)<=1,
                           yes = 6,
                           no = round(length(unique(protein_data$R.Condition)))/3*4)
    )

    ggsave_pdf_png(filename = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/CV_cumulative_frequency_plot"),
                   plot = cumsum_CV_plot,
                   limitsize = F,
                   width = 12,
                   height = 6
    )


# generate sample to condition file with measurement order ----------------

    message_function(text = "generating raw file / condition file ...",
                     color = "blue",
                     log_file_name = log_file_name)

    habil <- data %>%
      dplyr::distinct(.data$R.Condition,.data$R.FileName,.data$R.Replicate,.data$`R.Run Date`) %>%
      dplyr::arrange(.data$R.Condition) %>%
      dplyr::mutate(`R.Run Date` = lubridate::as_datetime(.data$`R.Run Date`)) %>%
      dplyr::mutate(measurement_order = dense_rank(.data$`R.Run Date`))

    readr::write_csv(x = habil,file = paste0(out_folder,"/","05_processed_data/",sample_length,"_sample_analysis/sample_to_condition_file.csv"))


# genrate output ----------------------------------------------------------

    if(dim(MedianNormalizationFactor_outlier)[1]==0){
      message_function(text = paste("no outlier detected with",parameter$normalization_factor_cutoff_outlier,"fold difference from the median"),
                       color = "blue",log_file_name = log_file_name)

      output_list <- list(data_input_normalized = data,
                          MedianNormalizationFactor = MedianNormalizationFactor,
                          MedianNormalizationFactor_outlier = MedianNormalizationFactor_outlier,
                          NormFactor_plot = NormFactor_plot,
                          iBAQ_intensities = data_iBAQ,
                          iBAQ_intensities_summary = data_iBAQ_summary,
                          protein_data = protein_data,
                          PG_2_peptides_ID_raw = raw_input$PG_2_peptides_ID_raw,
                          protein_data_normalization_factor = protein_data_normalization_factor,
                          peptide_intensity_filtered_2pep_hi3 = if(parameter$protein_intensity_estimation=="Hi3"){peptide_intensity_filtered_2pep_hi3}else{NULL},
                          peptide_intensity = peptide_intensity,
                          CV_cumulative_frequency = cumsum_CV,
                          sample_length = sample_length,
                          parameter = parameter_input)

      message_function(text = paste0("norm. & quant. module done --> please check outputs in folder: ", out_folder,"/","03_normalization/"),
                       color = "blue",
                       log_file_name = log_file_name)
      message_function(text = paste0("norm. & quant. module done --> please check outputs in folder: ", out_folder,"/","05_processed_data/"),
                       color = "blue",
                       log_file_name = log_file_name)

      class(output_list) <- "SpectroPipeR_norm_quant"
      return(output_list)
    }else{
      message_function(text = paste("Attention ---> OUTLIER detected !!!  >",parameter$normalization_factor_cutoff_outlier,"fold difference from the median"),
                       color = "yellow",
                       log_file_name = log_file_name)

      message_function(text = "samples:",color = "blue",log_file_name = log_file_name)
      message_function(text = paste(MedianNormalizationFactor_outlier$R.FileName,collapse = "\n"),color = "yellow",log_file_name = log_file_name)

      #writing outlier ID rate
      write_csv(x = MedianNormalizationFactor_outlier,
                file = paste0(out_folder,"/","03_normalization/",sample_length,"_sample_analysis/Median_normalization_outliers.csv"))

      output_list <- list(data_input_normalized = data,
                          MedianNormalizationFactor = MedianNormalizationFactor,
                          MedianNormalizationFactor_outlier = MedianNormalizationFactor_outlier,
                          NormFactor_plot = NormFactor_plot,
                          protein_data = protein_data,
                          iBAQ_intensities = data_iBAQ,
                          iBAQ_intensities_summary = data_iBAQ_summary,
                          PG_2_peptides_ID_raw = raw_input$PG_2_peptides_ID_raw,
                          protein_data_normalization_factor = protein_data_normalization_factor,
                          peptide_intensity_filtered_2pep_hi3 = if(parameter$protein_intensity_estimation=="Hi3"){peptide_intensity_filtered_2pep_hi3}else{NULL},
                          peptide_intensity = peptide_intensity,
                          peptide_intensity_batch_adjusted = peptide_intensity_batch_adjusted,
                          CV_cumulative_frequency = cumsum_CV,
                          sample_length = sample_length,
                          parameter = parameter_input)

      message_function(text = paste0("norm. & quant. module done --> please check outputs in folder: ", out_folder,"/","03_normalization/"),
                       color = "blue",
                       log_file_name = log_file_name)
      message_function(text = paste0("norm. & quant. module done --> please check outputs in folder: ", out_folder,"/","05_processed_data/"),
                       color = "blue",
                       log_file_name = log_file_name)

      class(output_list) <- "SpectroPipeR_norm_quant"
      return(output_list)
    }








}

